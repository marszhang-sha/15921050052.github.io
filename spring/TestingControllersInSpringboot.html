<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Unit and Integration Tests for RestControllers in Spring Boot | 油腻中年大叔</title>
    <meta name="description" content="你想要的这里都没有，你不想要的这里都有">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/github-markdown-css/2.2.1/github-markdown.css">
    
    <link rel="preload" href="/assets/css/styles.7863e8ac.css" as="style"><link rel="preload" href="/assets/js/app.7863e8ac.js" as="script"><link rel="preload" href="/assets/js/13.f5d738e8.js" as="script"><link rel="prefetch" href="/assets/js/0.eb7108e7.js"><link rel="prefetch" href="/assets/js/1.d8ec4d72.js"><link rel="prefetch" href="/assets/js/2.28f90b8d.js"><link rel="prefetch" href="/assets/js/3.6001361f.js"><link rel="prefetch" href="/assets/js/4.80c27a58.js"><link rel="prefetch" href="/assets/js/5.2e2f809b.js"><link rel="prefetch" href="/assets/js/6.0d0d8441.js"><link rel="prefetch" href="/assets/js/7.8e4037c3.js"><link rel="prefetch" href="/assets/js/8.5752a787.js"><link rel="prefetch" href="/assets/js/9.8329deb8.js"><link rel="prefetch" href="/assets/js/10.4843c5ba.js"><link rel="prefetch" href="/assets/js/11.9e8b7549.js"><link rel="prefetch" href="/assets/js/12.02c0fa30.js"><link rel="prefetch" href="/assets/js/14.ca4b3249.js"><link rel="prefetch" href="/assets/js/15.cf61b2ec.js"><link rel="prefetch" href="/assets/js/16.2b67aa0e.js"><link rel="prefetch" href="/assets/js/17.b99a459f.js"><link rel="prefetch" href="/assets/js/18.2d5afa9a.js"><link rel="prefetch" href="/assets/js/19.6c36dff4.js"><link rel="prefetch" href="/assets/js/20.3e0dc870.js"><link rel="prefetch" href="/assets/js/21.227ee5ec.js"><link rel="prefetch" href="/assets/js/22.05c1f0f0.js"><link rel="prefetch" href="/assets/js/23.c6dbeed0.js"><link rel="prefetch" href="/assets/js/24.957b4252.js"><link rel="prefetch" href="/assets/js/25.b50e4879.js"><link rel="prefetch" href="/assets/js/26.1b2b16cf.js"><link rel="prefetch" href="/assets/js/27.2f0f5e4c.js"><link rel="prefetch" href="/assets/js/28.ffafaa79.js"><link rel="prefetch" href="/assets/js/29.38ab4732.js"><link rel="prefetch" href="/assets/js/30.7258c2eb.js"><link rel="prefetch" href="/assets/js/31.6cc6f25e.js"><link rel="prefetch" href="/assets/js/32.cae8f5c2.js"><link rel="prefetch" href="/assets/js/33.7bac5900.js"><link rel="prefetch" href="/assets/js/34.e457a7ab.js"><link rel="prefetch" href="/assets/js/35.6a4f99be.js"><link rel="prefetch" href="/assets/js/36.3fa7b425.js"><link rel="prefetch" href="/assets/js/37.9627a576.js"><link rel="prefetch" href="/assets/js/38.8f902270.js"><link rel="prefetch" href="/assets/js/39.2fb6b1fd.js"><link rel="prefetch" href="/assets/js/40.0f992849.js"><link rel="prefetch" href="/assets/js/41.1921a30c.js"><link rel="prefetch" href="/assets/js/42.196053b0.js"><link rel="prefetch" href="/assets/js/43.6a2cc6b2.js"><link rel="prefetch" href="/assets/js/44.c3b31b69.js"><link rel="prefetch" href="/assets/js/45.dd90e897.js"><link rel="prefetch" href="/assets/js/46.547a7ce9.js"><link rel="prefetch" href="/assets/js/47.a62be284.js"><link rel="prefetch" href="/assets/js/48.edc6618c.js"><link rel="prefetch" href="/assets/js/49.b3d5118e.js"><link rel="prefetch" href="/assets/js/50.81540475.js"><link rel="prefetch" href="/assets/js/51.c2c1171b.js"><link rel="prefetch" href="/assets/js/52.ba318094.js"><link rel="prefetch" href="/assets/js/53.a2d5d15e.js"><link rel="prefetch" href="/assets/js/54.3608cfdf.js"><link rel="prefetch" href="/assets/js/55.73c0d459.js"><link rel="prefetch" href="/assets/js/56.9706fe8c.js"><link rel="prefetch" href="/assets/js/57.f5a08e9a.js"><link rel="prefetch" href="/assets/js/58.ea9c9ad0.js"><link rel="prefetch" href="/assets/js/59.9d363669.js"><link rel="prefetch" href="/assets/js/60.8a80b28f.js"><link rel="prefetch" href="/assets/js/61.73e5c6a8.js"><link rel="prefetch" href="/assets/js/62.30aab875.js"><link rel="prefetch" href="/assets/js/63.1e86c5c0.js"><link rel="prefetch" href="/assets/js/64.9c071a1e.js"><link rel="prefetch" href="/assets/js/65.61d8d11c.js"><link rel="prefetch" href="/assets/js/66.dd39544e.js"><link rel="prefetch" href="/assets/js/67.6dd79cd2.js"><link rel="prefetch" href="/assets/js/68.dd07b2a3.js"><link rel="prefetch" href="/assets/js/69.a5a81dbc.js"><link rel="prefetch" href="/assets/js/70.3f26faed.js"><link rel="prefetch" href="/assets/js/71.1234830b.js"><link rel="prefetch" href="/assets/js/72.d4db7f16.js"><link rel="prefetch" href="/assets/js/73.e2b0a283.js"><link rel="prefetch" href="/assets/js/74.db6d3ebc.js"><link rel="prefetch" href="/assets/js/75.4516323c.js"><link rel="prefetch" href="/assets/js/76.a086fd94.js"><link rel="prefetch" href="/assets/js/77.165f6d28.js"><link rel="prefetch" href="/assets/js/78.81cd058e.js"><link rel="prefetch" href="/assets/js/79.fde8c00b.js"><link rel="prefetch" href="/assets/js/80.142b728c.js"><link rel="prefetch" href="/assets/js/81.367c9c5e.js"><link rel="prefetch" href="/assets/js/82.d23176e0.js"><link rel="prefetch" href="/assets/js/83.d9571f6f.js"><link rel="prefetch" href="/assets/js/84.6214056c.js"><link rel="prefetch" href="/assets/js/85.66cc6092.js"><link rel="prefetch" href="/assets/js/86.18dba812.js"><link rel="prefetch" href="/assets/js/87.9506d9f8.js"><link rel="prefetch" href="/assets/js/88.b42d6720.js"><link rel="prefetch" href="/assets/js/89.5c0033c4.js"><link rel="prefetch" href="/assets/js/90.069a50d4.js"><link rel="prefetch" href="/assets/js/91.61fe3c31.js"><link rel="prefetch" href="/assets/js/92.e4211585.js"><link rel="prefetch" href="/assets/js/93.6df74471.js"><link rel="prefetch" href="/assets/js/94.d61ebe6e.js"><link rel="prefetch" href="/assets/js/95.c60c8a69.js"><link rel="prefetch" href="/assets/js/96.e3124488.js"><link rel="prefetch" href="/assets/js/97.bce37e32.js"><link rel="prefetch" href="/assets/js/98.a1fb95ac.js"><link rel="prefetch" href="/assets/js/99.f9c12b84.js"><link rel="prefetch" href="/assets/js/100.0b3aaca9.js"><link rel="prefetch" href="/assets/js/101.03f32ae7.js"><link rel="prefetch" href="/assets/js/102.69cca032.js"><link rel="prefetch" href="/assets/js/103.190dc3ef.js"><link rel="prefetch" href="/assets/js/104.6e7ceda7.js"><link rel="prefetch" href="/assets/js/105.f852f5a7.js"><link rel="prefetch" href="/assets/js/106.9335f238.js"><link rel="prefetch" href="/assets/js/107.1404f516.js"><link rel="prefetch" href="/assets/js/108.dd6bb5e3.js"><link rel="prefetch" href="/assets/js/109.a87f5640.js"><link rel="prefetch" href="/assets/js/110.fb0da049.js"><link rel="prefetch" href="/assets/js/111.cc64ddd7.js"><link rel="prefetch" href="/assets/css/112.styles.75c39ee5.css"><link rel="prefetch" href="/assets/js/112.75c39ee5.js"><link rel="prefetch" href="/assets/css/113.styles.407e8d7f.css"><link rel="prefetch" href="/assets/js/113.407e8d7f.js">
    <link rel="stylesheet" href="/assets/css/112.styles.75c39ee5.css"><link rel="stylesheet" href="/assets/css/113.styles.407e8d7f.css"><link rel="stylesheet" href="/assets/css/styles.7863e8ac.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">油腻中年大叔</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/dart/" class="nav-link">Dart</a></div><div class="nav-item"><a href="/spring/" class="nav-link router-link-active">spring</a></div><div class="nav-item"><a href="/drools/" class="nav-link">规则和业务流程</a></div><div class="nav-item"><a href="/eip/" class="nav-link">EIP集成工具</a></div><div class="nav-item"><a href="/other/" class="nav-link">杂项</a></div><div class="nav-item"><a href="/algorithms/" class="nav-link">算法</a></div><div class="nav-item"><a href="/riding/" class="nav-link">骑行</a></div><div class="nav-item"><a href="/ev3/" class="nav-link">LEGO EV3 </a></div><div class="nav-item"><a href="/rubik/" class="nav-link">魔方</a></div><div class="nav-item"><a href="/mb/" class="nav-link">Micro:bit </a></div><div class="nav-item"><a href="/math/" class="nav-link">小学数学 </a></div><div class="nav-item"><a href="/eng/" class="nav-link">小学英语 </a></div><div class="nav-item"><a href="/jp/" class="nav-link">日语 </a></div><div class="nav-item"><a href="/gs1/" class="nav-link">GS-1</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/dart/" class="nav-link">Dart</a></div><div class="nav-item"><a href="/spring/" class="nav-link router-link-active">spring</a></div><div class="nav-item"><a href="/drools/" class="nav-link">规则和业务流程</a></div><div class="nav-item"><a href="/eip/" class="nav-link">EIP集成工具</a></div><div class="nav-item"><a href="/other/" class="nav-link">杂项</a></div><div class="nav-item"><a href="/algorithms/" class="nav-link">算法</a></div><div class="nav-item"><a href="/riding/" class="nav-link">骑行</a></div><div class="nav-item"><a href="/ev3/" class="nav-link">LEGO EV3 </a></div><div class="nav-item"><a href="/rubik/" class="nav-link">魔方</a></div><div class="nav-item"><a href="/mb/" class="nav-link">Micro:bit </a></div><div class="nav-item"><a href="/math/" class="nav-link">小学数学 </a></div><div class="nav-item"><a href="/eng/" class="nav-link">小学英语 </a></div><div class="nav-item"><a href="/jp/" class="nav-link">日语 </a></div><div class="nav-item"><a href="/gs1/" class="nav-link">GS-1</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/spring/writetofile.html" class="sidebar-link">JavaIO-DataoutPut</a></li><li><a href="/spring/java-classloader.html" class="sidebar-link">java类加载器</a></li><li><a href="/spring/jvm-stack.html" class="sidebar-link">jvm 相关</a></li><li><a href="/spring/annotation.html" class="sidebar-link">注解的使用</a></li><li><a href="/spring/SpringAnnotations.html" class="sidebar-link">Spring注解速查</a></li><li><a href="/spring/springboot.html" class="sidebar-link">Springboot 配置速查</a></li><li><a href="/spring/springbootRun.html" class="sidebar-link">Springboot启动过程</a></li><li><a href="/spring/springboot-gitlab-ci.html" class="sidebar-link">Springboot基于Gitlab持续集成</a></li><li><a href="/spring/SpringBootTesting.html" class="sidebar-link">SpringBoot 测试</a></li><li><a href="/spring/SpringbootTesting2.html" class="sidebar-link">SpringBoot 测试建议</a></li><li><a href="/spring/TestingControllersInSpringboot.html" class="active sidebar-link">SpringBoot的Contoller测试</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/spring/TestingControllersInSpringboot.html#introduction" class="sidebar-link">Introduction</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/spring/TestingControllersInSpringboot.html#the-sample-application" class="sidebar-link">The sample application</a></li><li class="sidebar-sub-header"><a href="/spring/TestingControllersInSpringboot.html#server-and-client-side-tests" class="sidebar-link">Server and Client Side Tests</a></li></ul></li><li class="sidebar-sub-header"><a href="/spring/TestingControllersInSpringboot.html#server-side-tests" class="sidebar-link">Server-Side Tests</a></li><li class="sidebar-sub-header"><a href="/spring/TestingControllersInSpringboot.html#inside-server-tests" class="sidebar-link">Inside-Server Tests</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/spring/TestingControllersInSpringboot.html#策略-1-mockmvc-in-standalone-mode" class="sidebar-link">策略 1: MockMVC in Standalone Mode</a></li><li class="sidebar-sub-header"><a href="/spring/TestingControllersInSpringboot.html#策略-2-mockmvc-with-webapplicationcontext" class="sidebar-link">策略 2: MockMVC with WebApplicationContext</a></li><li class="sidebar-sub-header"><a href="/spring/TestingControllersInSpringboot.html#using-mockmvc-with-a-web-application-context-–-conclusions" class="sidebar-link">Using MockMVC with a Web Application Context – Conclusions</a></li></ul></li><li class="sidebar-sub-header"><a href="/spring/TestingControllersInSpringboot.html#outside-server-tests" class="sidebar-link">Outside-Server Tests</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/spring/TestingControllersInSpringboot.html#策略-3-springboottest-with-a-mock-webenvironment-value" class="sidebar-link">策略 3: SpringBootTest with a MOCK WebEnvironment value</a></li><li class="sidebar-sub-header"><a href="/spring/TestingControllersInSpringboot.html#策略-4-springboottest-with-a-real-web-server" class="sidebar-link">策略 4: SpringBootTest with a Real Web Server</a></li><li class="sidebar-sub-header"><a href="/spring/TestingControllersInSpringboot.html#springboottest-approach-–-conclusions" class="sidebar-link">SpringBootTest approach – Conclusions</a></li><li class="sidebar-sub-header"><a href="/spring/TestingControllersInSpringboot.html#performance-and-context-caching" class="sidebar-link">Performance and Context Caching</a></li></ul></li><li class="sidebar-sub-header"><a href="/spring/TestingControllersInSpringboot.html#conclusion" class="sidebar-link">Conclusion</a></li></ul></li><li><a href="/spring/JacksonObjectMapperCheetSheet.html" class="sidebar-link">Jackson ObjectMapper CheetSheet</a></li><li><a href="/spring/lock.html" class="sidebar-link">占用bug分析</a></li><li><a href="/spring/singleton-scope.html" class="sidebar-link">Spring MVC 并发与线程安全</a></li><li><a href="/spring/singleton.html" class="sidebar-link">设计模式-单件</a></li></ul> </div> <div class="page"> <div class="content"><h1 id="unit-and-integration-tests-for-restcontrollers-in-spring-boot"><a href="#unit-and-integration-tests-for-restcontrollers-in-spring-boot" aria-hidden="true" class="header-anchor">#</a> Unit and Integration Tests for RestControllers in Spring Boot</h1> <p><a href="https://thepracticaldeveloper.com/2017/07/31/guide-spring-boot-controller-tests/" target="_blank" rel="noopener noreferrer">原文链接<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
常用术语未做翻译：Spring Context,standalone，MockMvc，SpringRunner，SpringBootTest，Mocking,Filter,ControllerAdvice。</p> <p>在Spring Boot中有多种测试您的Controller（Web或API层）类的方法，有些提供了编写纯粹的<strong>单元测试</strong>的支持，而另一些则对<strong>集成测试</strong>更有用。在本文中，我将介绍可用于Spring的三种主要测试方法：在standalone模式下使用MockMVC，将MockMVC与SpringRunner一起使用，以及使用SpringBootTest。</p> <h2 id="introduction"><a href="#introduction" aria-hidden="true" class="header-anchor">#</a> Introduction</h2> <p>Springboot 提供了几种不同的方法用以测试。Springboot是一个不断发展进化的框架，新版本会有新的特性出现，而老的特性也会保留以便向后兼容。</p> <p>结果就是测试相同的一段带代码可以有不同的方法，并且有些方法并没有明确什么时候可以使用。</p> <p>本文将帮你理解不同的替代方法，这些方法可以使用的原因以及每一个方法的使用时机。</p> <p>本文主要针对于Controller的测试，因为这基本上是最不明确的部分，Mocking Object可以在不同的级别上出现。</p> <h3 id="the-sample-application"><a href="#the-sample-application" aria-hidden="true" class="header-anchor">#</a> The sample application</h3> <p>本文将使用一些示例代码来阐述不同的概念。</p> <p>所有的代码都位于GitHub:<a href="https://github.com/mechero/spring-boot-testing-strategies" target="_blank" rel="noopener noreferrer">Spring Boot Testing Strategies<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>简单来说，这是一个通过Rest API发布的实体-超级英雄存储库。</p> <p>下面列出了程序的一些特性以便更进一步的理解在使用不同的策略时候会发生什么：</p> <ul><li><p>如果不同通过identifier找到一个超级英雄，那么就抛出NonExistingHeroException异常。有一个Spring的@RestControllerAdvice 会拦截这个异常，然后把它转换成404状态-NOT_FOUND。</p></li> <li><p>在我们的HTTP通信中会用到一个SuperHeroFilter类，来向HTTP响应添加标头：X-SUPERHERO-APP</p></li></ul> <h3 id="server-and-client-side-tests"><a href="#server-and-client-side-tests" aria-hidden="true" class="header-anchor">#</a> Server and Client Side Tests</h3> <p>首先我们把<strong>服务器端测试和客户端测试</strong>分开：</p> <p>服务器端测试是最广泛的测试方式：执行请求，并且检查服务器的行为，响应组成，响应内容等。</p> <p>而<strong>客户端的测试</strong>不太常见，当你想验证请求的组成和动作，他们是有用的。在这些测试中，你会模拟服务器行为，然后间接地调用一些代码，这些代码将间接地对该服务器执行请求。这正是你想要测试的内容，你想验证是否存在请求以及该请求的内容。您不关心响应的内容（你模拟了那部分内容）。不幸的是，没有很多好的关于客户端测试的例子。即使你看了<a href="https://github.com/spring-projects/spring-framework/blob/master/spring-test/src/test/java/org/springframework/test/web/client/samples/SampleTests.java" target="_blank" rel="noopener noreferrer">官方示例<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，它们也并不是那么有用（请参阅Javadoc注释）。反正重要的概念是，当你开发一个客户端程序，并且需要验证从客户端向外部发出的请求的时候，你会用到这种测试。</p> <p><strong>我们将专注于服务器端测试</strong>，验证服务器逻辑是否有效。在这种情况下，通常会模拟请求，并且检查服务器逻辑的输出。这类测试与应用程序中的Controller层紧密相关，因为它是Spring负责处理HTTP请求的那部分。</p> <h2 id="server-side-tests"><a href="#server-side-tests" aria-hidden="true" class="header-anchor">#</a> Server-Side Tests</h2> <p>如果我们深入研究服务器端测试，在Spring有两种策略可以使用：</p> <ul><li>使用MockMVC方法编写Controller测试，</li> <li>或使用RestTemplate。</li></ul> <p>如果要编写一个<strong>真正</strong>的单元测试，则应该首选第一种策略（MockMVC），而如果要编写集成测试，则应使用RestTemplate。原因是使用MockMVC，我们可以为Controller细化断言。另一方面，RestTemplate将使用Spring的WebApplicationContext（部分或全部取决于是否使用Standalone模式）。后面我们将更详细地说明这两种策略。</p> <h2 id="inside-server-tests"><a href="#inside-server-tests" aria-hidden="true" class="header-anchor">#</a> Inside-Server Tests</h2> <p>我们可以直接测试Controller逻辑，而无需运行Web服务器。这叫做Inside-Server测试，它比较接近于单元测试的定义。为了做这个测试，你需要模拟整个Web服务器的行为，因此就某种程度上来说，有部分程序没有被测试到。但是不用担心，因为集成测试可以完美覆盖这些部分。</p> <h3 id="策略-1-mockmvc-in-standalone-mode"><a href="#策略-1-mockmvc-in-standalone-mode" aria-hidden="true" class="header-anchor">#</a> 策略 1: MockMVC in Standalone Mode</h3> <p><img src="/assets/img/tests_mockmvc_wm.af574837.png" alt="mockmvc_wm"></p> <p>在Spring中，你可以以Standalone使用MockMVC来编写inside-server测试用例，<strong>而不会加载任何Context</strong>。让我们来看一个例子。</p> <h4 id="mockmvc-standalone-code-example"><a href="#mockmvc-standalone-code-example" aria-hidden="true" class="header-anchor">#</a> MockMVC standalone code example</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span>MockitoJUnitRunner<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SuperHeroControllerMockMvcStandaloneTest</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> MockMvc mvc<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Mock</span>
    <span class="token keyword">private</span> SuperHeroRepository superHeroRepository<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@InjectMocks</span>
    <span class="token keyword">private</span> SuperHeroController superHeroController<span class="token punctuation">;</span>

    <span class="token comment">// This object will be magically initialized by the initFields method below.</span>
    <span class="token keyword">private</span> JacksonTester<span class="token operator">&amp;</span>lt<span class="token punctuation">;</span>SuperHero<span class="token operator">&amp;</span>gt<span class="token punctuation">;</span> jsonSuperHero<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Before</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// We would need this line if we would not use MockitoJUnitRunner</span>
        <span class="token comment">// MockitoAnnotations.initMocks(this);</span>
        <span class="token comment">// Initializes the JacksonTester</span>
        JacksonTester<span class="token punctuation">.</span><span class="token function">initFields</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// MockMvc standalone approach</span>
        mvc <span class="token operator">=</span> MockMvcBuilders<span class="token punctuation">.</span><span class="token function">standaloneSetup</span><span class="token punctuation">(</span>superHeroController<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setControllerAdvice</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SuperHeroExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addFilters</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SuperHeroFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">canRetrieveByIdWhenExists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment">// given</span>
        <span class="token function">given</span><span class="token punctuation">(</span>superHeroRepository<span class="token punctuation">.</span><span class="token function">getSuperHero</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">willReturn</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SuperHero</span><span class="token punctuation">(</span><span class="token string">&quot;Rob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Mannon&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;RobotMan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// when</span>
        MockHttpServletResponse response <span class="token operator">=</span> mvc<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span>
                <span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/superheroes/2&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>MediaType<span class="token punctuation">.</span>APPLICATION_JSON<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">andReturn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// then</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span>HttpStatus<span class="token punctuation">.</span>OK<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getContentAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span>
                jsonSuperHero<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SuperHero</span><span class="token punctuation">(</span><span class="token string">&quot;Rob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Mannon&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;RobotMan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">canRetrieveByIdWhenDoesNotExist</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment">// given</span>
        <span class="token function">given</span><span class="token punctuation">(</span>superHeroRepository<span class="token punctuation">.</span><span class="token function">getSuperHero</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">willThrow</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NonExistingHeroException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// when</span>
        MockHttpServletResponse response <span class="token operator">=</span> mvc<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span>
                <span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/superheroes/2&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>MediaType<span class="token punctuation">.</span>APPLICATION_JSON<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">andReturn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// then</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span>HttpStatus<span class="token punctuation">.</span>NOT_FOUND<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getContentAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">canRetrieveByNameWhenExists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment">// given</span>
        <span class="token function">given</span><span class="token punctuation">(</span>superHeroRepository<span class="token punctuation">.</span><span class="token function">getSuperHero</span><span class="token punctuation">(</span><span class="token string">&quot;RobotMan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">willReturn</span><span class="token punctuation">(</span>Optional<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SuperHero</span><span class="token punctuation">(</span><span class="token string">&quot;Rob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Mannon&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;RobotMan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// when</span>
        MockHttpServletResponse response <span class="token operator">=</span> mvc<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span>
                <span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/superheroes/?name=RobotMan&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>MediaType<span class="token punctuation">.</span>APPLICATION_JSON<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">andReturn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// then</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span>HttpStatus<span class="token punctuation">.</span>OK<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getContentAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span>
                jsonSuperHero<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SuperHero</span><span class="token punctuation">(</span><span class="token string">&quot;Rob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Mannon&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;RobotMan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">canRetrieveByNameWhenDoesNotExist</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment">// given</span>
        <span class="token function">given</span><span class="token punctuation">(</span>superHeroRepository<span class="token punctuation">.</span><span class="token function">getSuperHero</span><span class="token punctuation">(</span><span class="token string">&quot;RobotMan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">willReturn</span><span class="token punctuation">(</span>Optional<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// when</span>
        MockHttpServletResponse response <span class="token operator">=</span> mvc<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span>
                <span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/superheroes/?name=RobotMan&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>MediaType<span class="token punctuation">.</span>APPLICATION_JSON<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">andReturn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// then</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span>HttpStatus<span class="token punctuation">.</span>OK<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getContentAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token string">&quot;null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">canCreateANewSuperHero</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment">// when</span>
        MockHttpServletResponse response <span class="token operator">=</span> mvc<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span>
                <span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/superheroes/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contentType</span><span class="token punctuation">(</span>MediaType<span class="token punctuation">.</span>APPLICATION_JSON<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span>
                        jsonSuperHero<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SuperHero</span><span class="token punctuation">(</span><span class="token string">&quot;Rob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Mannon&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;RobotMan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">andReturn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// then</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span>HttpStatus<span class="token punctuation">.</span>CREATED<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">headerIsPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment">// when</span>
        MockHttpServletResponse response <span class="token operator">=</span> mvc<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span>
                <span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/superheroes/2&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>MediaType<span class="token punctuation">.</span>APPLICATION_JSON<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">andReturn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// then</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span>HttpStatus<span class="token punctuation">.</span>OK<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token string">&quot;X-SUPERHERO-APP&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">containsOnly</span><span class="token punctuation">(</span><span class="token string">&quot;super-header&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br></div></div><p>下面一节将详尽的解释这段代码</p> <h4 id="mockitojunitrunner-and-mockmvc"><a href="#mockitojunitrunner-and-mockmvc" aria-hidden="true" class="header-anchor">#</a> MockitoJUnitRunner and MockMVC</h4> <p>我们使用<code>MockitoJUnitRunner</code>来运行单元测试。这由Mockito提供，并在内置的JUnit运行器之上添加了一些功能：检测到正在使用该框架，没有未使用的stubs，并为我们初始化了所有带<code>@Mock</code>注解的字段，因此我们不需要调用<code>Mockito.initMocks()</code>方法。</p> <p>请注意我们如何初始化模拟：使用注解正常的模拟了<code>SuperHeroRepository</code>。但是，我们需要在真正的controller中用到它，因此在<code>SuperHeroController</code>实例上使用了<code>@InjectMocks</code>注解。这样，模拟的<code>SuperHeroRepository</code>将被注入到控制器中，而不是真正的bean实例。</p> <p>对于每个测试，我们都使用<code>MockMVC</code> 实例执行各种假请求（GET，POST等），并且会收到<code>MockHttpServletResponse</code>响应。请记住，这也不是真正的响应，所有的东西都被模拟了。</p> <h4 id="jacksontester-initialization"><a href="#jacksontester-initialization" aria-hidden="true" class="header-anchor">#</a> JacksonTester initialization</h4> <p>使用<code>JacksonTester.initFields()</code>自动注入了一个<code>JacksonTesterobject</code>。这是Spring提供的一个工具类，并且你看到它要使用<code>静态方法初始化</code>，所以这有点微妙。</p> <p>在setup方法（每次测试之前需要执行的方法）中，我们以Standalone模式配置MockMVC，并<strong>显示的配置被测试的Controller，ControllerAdvice和HTTP Filter</strong>但是，不管怎样，您已经看到了这种方法的主要缺点：在ControllerAdvice，Filters等中建模的逻辑的任何部分都配置在这，这是因为您没有任何可以自动注入它们的Spring context。</p> <h4 id="testing-controlleradvices-and-filters-with-mockmvc"><a href="#testing-controlleradvices-and-filters-with-mockmvc" aria-hidden="true" class="header-anchor">#</a> Testing ControllerAdvices and Filters with MockMVC</h4> <p>请注意如何验证周围的内容：在第60行中，我们用检查一个ID不存在的请求，看他是否以NOT_FOUND结束，因此<code>ControllerAdvice</code>可以正常工作。我们还有一个测试（113行）来验证标头是否存在，因此我们Filter 也在工作。您可以改一下代码看看：删除Standalone设置中指定Advice和Filter的部分，然后再次运行测试。不出所料的话，在这种情况下它将失败，因为没有Context可以注入这些类。</p> <p>为了这篇文章的教学目的，我在此测试中包括了Filter和ControllerAdvice。但是我们可以不这样做，而将标头测试和404测试留给<strong>集成测试</strong>（因此我们从此处和独立配置中将其删除）。如果这样做，就是一个<strong>纯粹的单元测试：我们将仅测试Controller类的逻辑，而无其他干扰项</strong>。</p> <p>顺便提一下：该代码使用BDDMockito和AssertJ编写了human-readable, fluent-style的测试。如果您想了解更多有关此技术的知识，请保存另一文章以便后面阅读：
【Write BDD Unit Tests with BDDMockito and AssertJ](https://thepracticaldeveloper.com/2018/05/10/write-bdd-unit-tests-with-bddmockito-and-assertj/)</p> <h3 id="策略-2-mockmvc-with-webapplicationcontext"><a href="#策略-2-mockmvc-with-webapplicationcontext" aria-hidden="true" class="header-anchor">#</a> 策略 2: MockMVC with WebApplicationContext</h3> <p>这种模式下，我们还可以使用<code>MockMC</code>来编写测试用例，但是我们会加载Spring的<code>WebApplicationContext</code>。因为我们还在使用inside-server策略，所以不会部署web server。</p> <p><img src="/assets/img/tests_springboot_wm-1.acbe1e39.png" alt="wm1"></p> <h4 id="mockmvc-and-webmvctest-code-example"><a href="#mockmvc-and-webmvctest-code-example" aria-hidden="true" class="header-anchor">#</a> MockMVC and WebMvcTest code example</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span>SpringRunner<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@WebMvcTest</span><span class="token punctuation">(</span>SuperHeroController<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SuperHeroControllerMockMvcWithContextTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> MockMvc mvc<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@MockBean</span>
    <span class="token keyword">private</span> SuperHeroRepository superHeroRepository<span class="token punctuation">;</span>

    <span class="token comment">// This object will be magically initialized by the initFields method below.</span>
    <span class="token keyword">private</span> JacksonTester<span class="token generics function"><span class="token punctuation">&lt;</span>SuperHero<span class="token punctuation">&gt;</span></span> jsonSuperHero<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Before</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Initializes the JacksonTester</span>
        JacksonTester<span class="token punctuation">.</span><span class="token function">initFields</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">canRetrieveByIdWhenExists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment">// given</span>
        <span class="token function">given</span><span class="token punctuation">(</span>superHeroRepository<span class="token punctuation">.</span><span class="token function">getSuperHero</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">willReturn</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SuperHero</span><span class="token punctuation">(</span><span class="token string">&quot;Rob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Mannon&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;RobotMan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// when</span>
        MockHttpServletResponse response <span class="token operator">=</span> mvc<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span>
                <span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/superheroes/2&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>MediaType<span class="token punctuation">.</span>APPLICATION_JSON<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">andReturn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// then</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span>HttpStatus<span class="token punctuation">.</span>OK<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getContentAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span>
                jsonSuperHero<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SuperHero</span><span class="token punctuation">(</span><span class="token string">&quot;Rob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Mannon&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;RobotMan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...</span>
    <span class="token comment">// Rest of the class omitted, it's the same implementation as in Standalone mode</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>如果与StandAlone模式对比，主要有这样一些不同：</p> <h5 id="springrunner"><a href="#springrunner" aria-hidden="true" class="header-anchor">#</a> SpringRunner</h5> <p>测试通过<code>SpringRunner</code>执行，这就是context或者部分context如何初始化的。当你运行测试的时候，你在一开始的日志trace中可以看到context启动以及bean的注入。</p> <h5 id="mockmvc-autoconfiguration"><a href="#mockmvc-autoconfiguration" aria-hidden="true" class="header-anchor">#</a> MockMVC Autoconfiguration</h5> <p>通过<code>@WebMVCTest</code>注解，<code>MockMVC</code>实例在context中被自动配置（所以后面我们使用autowire就可以拿到它）。除此之外，我们在注解中指定了要被测试的Controller类。Spring只会部分加载context(controller以及和它相关的配置)。</p> <p>注解的实现足够智能，它知道应该还把过滤器和ControllerAdvice注入，所以在这种方法中，不需要显示的在<code>setup()</code>方法里面配置。</p> <p>@WebMvcTest only auto-configures the Spring MVC infrastructure and limits scanned beans to @Controller, @ControllerAdvice, @JsonComponent, Filter, WebMvcConfigurer, and HandlerMethodArgumentResolver beans.</p> <p>When you use @WebMvcTest, regular @Component, @Service, or @Repository beans will not be scanned – an important point to differentiate @WebMvcTest from a full-blown @SpringBootTest.</p> <p>If you’re looking to load your full application configuration and use MockMVC, you should consider @SpringBootTest combined with @AutoConfigureMockMvc rather than @WebMvcTest. I will cover it in an upcoming post of this Spring MVC testing series. I will also help you to explore more about mocking services and JPA repositories with @MockBean combined with @DataJpaTest and @WebMvcTest, and also how to unit test RESTful controller’s GETs and POSTs using MockMvc and @JsonTest.</p> <h5 id="overriding-beans-for-testing-using-mockbean"><a href="#overriding-beans-for-testing-using-mockbean" aria-hidden="true" class="header-anchor">#</a> Overriding beans for testing using MockBean</h5> <p>Now the repository is injected in the Spring’s context using @MockBean. We don’t need to make any reference to our controller class apart from the one in the annotation, since the controller will be injected and available. This bean will just replace the real repository implementation.</p> <p>现在使用<code>@MockBean</code>把repository注入到了<strong>Spring的Context</strong>中。除了注解，我们不需要再引用Controller类，因为Controller会被注入并可用。Mock的Bean会替代掉真正的SuperHeroRepository实现</p> <h5 id="no-server-calls"><a href="#no-server-calls" aria-hidden="true" class="header-anchor">#</a> No server calls</h5> <p>记住，我们验证的响应仍然是假的。因为在这个测试中还没有web服务器。无论如何，这是一个相当有效的测试,因为我们在类内部验证我们的逻辑，同时也验证了其他的一些参与者（<code>SuperHeroExceptionHandler</code>和<code>SuperHeroFilter</code>）</p> <h3 id="using-mockmvc-with-a-web-application-context-–-conclusions"><a href="#using-mockmvc-with-a-web-application-context-–-conclusions" aria-hidden="true" class="header-anchor">#</a> Using MockMVC with a Web Application Context – Conclusions</h3> <p>最主要区别是我们不需要显示的加载一些参与类，因为存在有Spring的Context。如果我们创建了新的过滤器，新的ControllerAdvice或者其他在请求-响应过程中的参与类，他们会被自动的注入到测试用。所以我们不需要手动配置。在测试中没有进行细粒度的控制，用什么或者不用什么，但是者更接近于真实情况。当我们运行应用程序时，默认情况下所有这些东西都存在。</p> <p>你可以把这种方法当做向集成测试的一个小的过渡。在这种情况下，过滤器和ControllerAdvice在测试中开箱即用，无需做任何的引用。如果未来有其他的类会干预请求-响应流，他也将参与到这个测试中。</p> <p>由于此测试包含不止一个类，因此您可以将其归类为这些类之间的集成测试。但是，这条线是模糊的：另一方面，您可能会说只有一个控制器被测试，但是您需要额外的配置才能正确地对其进行测试。</p> <h2 id="outside-server-tests"><a href="#outside-server-tests" aria-hidden="true" class="header-anchor">#</a> Outside-Server Tests</h2> <p>我把向应用程序发出HTTP请求进行测试的方式称为**“outside-server&quot;**测试，但是，即使在server之外，你可以给这些测试注入一些模拟对象，所以在这种测试中，你能获得跟单元测试类似的内容。
例如，在传统的3层应用程序中，您可以模拟Service层，并通过Web服务器仅测试Controller。但是，实际上，<strong>这种方法比普通的单元测试要重得多</strong>。 你加载了整个应用程序上下文，除非你在测试期间告诉Spring不要这样做（通过配置排除或仅包括所需的内容）</p> <p>在Spring中，你可以使用<code>RestTemplate</code>来为REST Controller编写outside-server测试用例来执行请求，或者用新的TestRestTemplate，它拥有集成测试的一些有用功能（包括身份验证标头和容错能力）</p> <p>在Spring Boot中， 你也可以使用<code>@SpringBootTest</code>注解。之后通过开箱即用的模式，你可以获得一些注入到Context中的bean，可以访问从<code>application.properties</code>中加载的属性，等等。它是<code>@ContextConfiguration</code>（Spring）的替代，它可以为测试提供所有的Spring Boot特性。</p> <p>在Spring Boot中的测试策略容易引起混淆，因为有太多的特性和可用的选项。让我们看一下这些策略，如同之前我们研究MockMVC一样。</p> <h3 id="策略-3-springboottest-with-a-mock-webenvironment-value"><a href="#策略-3-springboottest-with-a-mock-webenvironment-value" aria-hidden="true" class="header-anchor">#</a> 策略 3: SpringBootTest with a MOCK WebEnvironment value</h3> <p>如果你使用<code>@SpringBootTest</code> 或者<code>@SpringBootTesst(webEnvironment = WebEnvironment.MOCK)</code>, 就不会加载一个真的HTTP 服务器。是不是听起来很熟悉？这跟策略2（MockMVC with an application context）非常接近。所以，虽然在理论上我们使用了<code>@Springboot</code>注解开发outside-server测试用例，但是当把WebEnviroment设为Mock的时候，我们其实在做inside-server测试。</p> <p>我们不能使用<code>RestTemplate</code>，因此我们没有任何Web服务器，所以我们继续使用<code>MockMVC</code>，这通过额外的注解<code>@AutoConfigureMockMVC</code>完成配置。我认为这是所有可用方法之间最棘手的方法，因此我个人不鼓励使用它。</p> <p>最好使用加载特定Controller的策略2，这样你对测试有更多的控制。</p> <h3 id="策略-4-springboottest-with-a-real-web-server"><a href="#策略-4-springboottest-with-a-real-web-server" aria-hidden="true" class="header-anchor">#</a> 策略 4: SpringBootTest with a Real Web Server</h3> <p><img src="/assets/img/tests_springboot_wm-1.acbe1e39.png" alt="wm1"></p> <p>当您使用<code>@SpringBootTest(webEnvironment = WebEnvironment.RANDOM_PORT)</code>或<code>@SpringBootTest(webEnvironment = WebEnvironment.DEFINED_PORT)</code>，那就是通过真正的HTTP Server进行测试了，在这种情况下，你需要使用<code>RestTemplate</code> 或<code>TestRestTemplate</code>。使用随机端口或已定义端口之间的区别是，在第一种情况下，<code>server.port</code> 将不会使用默认端口8080（或server.port属性指定的端口），而是将其替换为随机分配的端口号。这当您要运行并行测试时很有用，可以避免端口冲突。让我们看一下代码，然后说明主要部分。</p> <h4 id="spring-boot-test-code-example"><a href="#spring-boot-test-code-example" aria-hidden="true" class="header-anchor">#</a> Spring Boot Test Code Example</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span>SpringRunner<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span><span class="token punctuation">(</span>webEnvironment <span class="token operator">=</span> WebEnvironment<span class="token punctuation">.</span>RANDOM_PORT<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SuperHeroControllerSpringBootTest</span> <span class="token punctuation">{</span>
 
    <span class="token annotation punctuation">@MockBean</span>
    <span class="token keyword">private</span> SuperHeroRepository superHeroRepository<span class="token punctuation">;</span>
 
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> TestRestTemplate restTemplate<span class="token punctuation">;</span>
 
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">canRetrieveByIdWhenExists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// given</span>
        <span class="token function">given</span><span class="token punctuation">(</span>superHeroRepository<span class="token punctuation">.</span><span class="token function">getSuperHero</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">willReturn</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SuperHero</span><span class="token punctuation">(</span><span class="token string">&quot;Rob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Mannon&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;RobotMan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token comment">// when</span>
        ResponseEntity<span class="token generics function"><span class="token punctuation">&lt;</span>SuperHero<span class="token punctuation">&gt;</span></span> superHeroResponse <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForEntity</span><span class="token punctuation">(</span><span class="token string">&quot;/superheroes/2&quot;</span><span class="token punctuation">,</span> SuperHero<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token comment">// then</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>superHeroResponse<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span>HttpStatus<span class="token punctuation">.</span>OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>superHeroResponse<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SuperHero</span><span class="token punctuation">(</span><span class="token string">&quot;Rob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Mannon&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;RobotMan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">canRetrieveByIdWhenDoesNotExist</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// given</span>
        <span class="token function">given</span><span class="token punctuation">(</span>superHeroRepository<span class="token punctuation">.</span><span class="token function">getSuperHero</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">willThrow</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NonExistingHeroException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token comment">// when</span>
        ResponseEntity<span class="token generics function"><span class="token punctuation">&lt;</span>SuperHero<span class="token punctuation">&gt;</span></span> superHeroResponse <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForEntity</span><span class="token punctuation">(</span><span class="token string">&quot;/superheroes/2&quot;</span><span class="token punctuation">,</span> SuperHero<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token comment">// then</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>superHeroResponse<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span>HttpStatus<span class="token punctuation">.</span>NOT_FOUND<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>superHeroResponse<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">canRetrieveByNameWhenExists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// given</span>
        <span class="token function">given</span><span class="token punctuation">(</span>superHeroRepository<span class="token punctuation">.</span><span class="token function">getSuperHero</span><span class="token punctuation">(</span><span class="token string">&quot;RobotMan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">willReturn</span><span class="token punctuation">(</span>Optional<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SuperHero</span><span class="token punctuation">(</span><span class="token string">&quot;Rob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Mannon&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;RobotMan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token comment">// when</span>
        ResponseEntity<span class="token generics function"><span class="token punctuation">&lt;</span>SuperHero<span class="token punctuation">&gt;</span></span> superHeroResponse <span class="token operator">=</span> restTemplate
                <span class="token punctuation">.</span><span class="token function">getForEntity</span><span class="token punctuation">(</span><span class="token string">&quot;/superheroes/?name=RobotMan&quot;</span><span class="token punctuation">,</span> SuperHero<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token comment">// then</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>superHeroResponse<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span>HttpStatus<span class="token punctuation">.</span>OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>superHeroResponse<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SuperHero</span><span class="token punctuation">(</span><span class="token string">&quot;Rob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Mannon&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;RobotMan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">canRetrieveByNameWhenDoesNotExist</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// given</span>
        <span class="token function">given</span><span class="token punctuation">(</span>superHeroRepository<span class="token punctuation">.</span><span class="token function">getSuperHero</span><span class="token punctuation">(</span><span class="token string">&quot;RobotMan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">willReturn</span><span class="token punctuation">(</span>Optional<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token comment">// when</span>
        ResponseEntity<span class="token generics function"><span class="token punctuation">&lt;</span>SuperHero<span class="token punctuation">&gt;</span></span> superHeroResponse <span class="token operator">=</span> restTemplate
                <span class="token punctuation">.</span><span class="token function">getForEntity</span><span class="token punctuation">(</span><span class="token string">&quot;/superheroes/?name=RobotMan&quot;</span><span class="token punctuation">,</span> SuperHero<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token comment">// then</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>superHeroResponse<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span>HttpStatus<span class="token punctuation">.</span>OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>superHeroResponse<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">canCreateANewSuperHero</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// when</span>
        ResponseEntity<span class="token generics function"><span class="token punctuation">&lt;</span>SuperHero<span class="token punctuation">&gt;</span></span> superHeroResponse <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">postForEntity</span><span class="token punctuation">(</span><span class="token string">&quot;/superheroes/&quot;</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">SuperHero</span><span class="token punctuation">(</span><span class="token string">&quot;Rob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Mannon&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;RobotMan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SuperHero<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token comment">// then</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>superHeroResponse<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span>HttpStatus<span class="token punctuation">.</span>CREATED<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">headerIsPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment">// when</span>
        ResponseEntity<span class="token generics function"><span class="token punctuation">&lt;</span>SuperHero<span class="token punctuation">&gt;</span></span> superHeroResponse <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForEntity</span><span class="token punctuation">(</span><span class="token string">&quot;/superheroes/2&quot;</span><span class="token punctuation">,</span> SuperHero<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token comment">// then</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>superHeroResponse<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span>HttpStatus<span class="token punctuation">.</span>OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>superHeroResponse<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;X-SUPERHERO-APP&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">containsOnly</span><span class="token punctuation">(</span><span class="token string">&quot;super-header&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br></div></div><p>现在我们开看主要区别。</p> <h5 id="web-server-testing"><a href="#web-server-testing" aria-hidden="true" class="header-anchor">#</a> Web Server Testing</h5> <p>我们使用<code>SpringRunner</code>来执行测试，但是我们用<code>@SpringBootTest</code>来注解声明使用RANDOM_PORT模式。完成这步，我们就拥有了一个可以执行测试的WEB服务器。</p> <p>现在我们用模板（18行）来触发请求，就跟我们访问外部服务器一样。</p> <p>断言有一些变化，因为我们要确定这是一个<code>ResponseEntity</code>而不是一个<code>MockHttpServletResponse</code></p> <h5 id="mocking-layers"><a href="#mocking-layers" aria-hidden="true" class="header-anchor">#</a> Mocking layers</h5> <p>注意我们现在仍然使用<code>@MockBean</code>注解来模拟repository</p> <h5 id="testresttemplate"><a href="#testresttemplate" aria-hidden="true" class="header-anchor">#</a> TestRestTemplate</h5> <p>我们可以注入一个<code>TestRestTemplate</code>对象，因为我们使用的是<code>@SpringBootTest</code>。它与标准RestTemplate作用完全相同，但是之前看到的一些额外的功能。</p> <h3 id="springboottest-approach-–-conclusions"><a href="#springboottest-approach-–-conclusions" aria-hidden="true" class="header-anchor">#</a> SpringBootTest approach – Conclusions</h3> <p>即使我们的目标是相同的——测试Controller层，这种测试方法与策略1（Standalone下的MockMVC）相比较，也是从<strong>完全不同的角度解决问题</strong>。之前，我们只是在加载类并不包括周围的参与者（Filter和ControllerAdvice）。现在，我们加载了包括Web服务器在内的整个Spring Boot Context。这种方法是最重的，并且<strong>离单元测试的概念最远</strong>。</p> <p>这种策略主要用于<strong>集成测试</strong>。您仍然可以模拟bean并在上下文中替换它们，但是您可以验证Spring Boot应用程序中不同类之间的交互，以及Web服务器的参与。</p> <p>我的建议是，应避免在单元测试中采用这种策略。这样测试用例变胖，并且你可能无法控制要测试的内容。但是不要误会我的意思，对于集成测试，你应该倾向于这种方法：这层测试在验证不同的组件如何在一起工作时候是很有用的。</p> <h3 id="performance-and-context-caching"><a href="#performance-and-context-caching" aria-hidden="true" class="header-anchor">#</a> Performance and Context Caching</h3> <p>您可能会认为策略1的性能要比其他策略更好。或者，如果您每次运行测试时都需要加载整个Spring Boot Context，则Strategy 4可能会表现糟糕。嗯，这并不完全正确。当您使用Spring（包括Boot）进行测试时，默认情况下，<strong>在同一Test Suite中Spring Context会被复用</strong>。</p> <p>这意味着策略2、3和4在首次加载Spring Context后会复用它。请注意，如果你的测试用例修改了Context中包含的bean，则Context复用可能会引起一些副作用。如果是这种情况，你需要对<code>@DirtiesContext</code>注解做一些变通，表明您想重新加载Context（请参阅<a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/integration-testing.html#__dirtiescontext" target="_blank" rel="noopener noreferrer">完整的文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）。</p> <h2 id="conclusion"><a href="#conclusion" aria-hidden="true" class="header-anchor">#</a> Conclusion</h2> <p>如上文，针对在Spring Boot中统一测试Controller，我们讲了从最轻到最终的方法。现在是时候给出有关<strong>何时用什么</strong>的个人建议了：</p> <ul><li><p>为Controller逻辑编写单元测试，而不关注其他行为。选择<strong>策略1：use MockMVC in Standalone mode.</strong>。</p></li> <li><p>如果你需要测试与WEB层相关的一些周边行为（例如过滤，拦截，认证等），那么选择<strong>策略4：SpringBootTest with a web server on a random port</strong>。但是请把它作为单独的集成测试，以你为你在验证应用程序的不同组成。如果需要，请勿跳过纯Controller层的单元测试。换句话说，尽可能的分开测试不同的层，而不是混在一起测试。</p></li></ul> <p>我希望这篇指南对你有所帮助。欢迎用过评论给与反馈。</p> <p>如果您正在研究测试Controller，也许您也对REST控制器中的自定义错误处理感兴趣，请查看<a href="https://thepracticaldeveloper.com/2019/09/09/custom-error-handling-rest-controllers-spring-boot/" target="_blank" rel="noopener noreferrer">新指南<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>以获取更多详细信息。</p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/spring/SpringbootTesting2.html" class="prev">
          SpringBoot 测试建议
        </a></span> <span class="next"><a href="/spring/JacksonObjectMapperCheetSheet.html">
          Jackson ObjectMapper CheetSheet
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/13.f5d738e8.js" defer></script><script src="/assets/js/app.7863e8ac.js" defer></script>
  </body>
</html>
