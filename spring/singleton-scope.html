<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Controller 是否线程安全 | 油腻中年大叔</title>
    <meta name="description" content="你想要的这里都没有，你不想要的这里都有">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/github-markdown-css/2.2.1/github-markdown.css">
    
    <link rel="preload" href="/assets/css/styles.7863e8ac.css" as="style"><link rel="preload" href="/assets/js/app.7863e8ac.js" as="script"><link rel="preload" href="/assets/js/6.0d0d8441.js" as="script"><link rel="prefetch" href="/assets/js/0.eb7108e7.js"><link rel="prefetch" href="/assets/js/1.d8ec4d72.js"><link rel="prefetch" href="/assets/js/2.28f90b8d.js"><link rel="prefetch" href="/assets/js/3.6001361f.js"><link rel="prefetch" href="/assets/js/4.80c27a58.js"><link rel="prefetch" href="/assets/js/5.2e2f809b.js"><link rel="prefetch" href="/assets/js/7.8e4037c3.js"><link rel="prefetch" href="/assets/js/8.5752a787.js"><link rel="prefetch" href="/assets/js/9.8329deb8.js"><link rel="prefetch" href="/assets/js/10.4843c5ba.js"><link rel="prefetch" href="/assets/js/11.9e8b7549.js"><link rel="prefetch" href="/assets/js/12.02c0fa30.js"><link rel="prefetch" href="/assets/js/13.f5d738e8.js"><link rel="prefetch" href="/assets/js/14.ca4b3249.js"><link rel="prefetch" href="/assets/js/15.cf61b2ec.js"><link rel="prefetch" href="/assets/js/16.2b67aa0e.js"><link rel="prefetch" href="/assets/js/17.b99a459f.js"><link rel="prefetch" href="/assets/js/18.2d5afa9a.js"><link rel="prefetch" href="/assets/js/19.6c36dff4.js"><link rel="prefetch" href="/assets/js/20.3e0dc870.js"><link rel="prefetch" href="/assets/js/21.227ee5ec.js"><link rel="prefetch" href="/assets/js/22.05c1f0f0.js"><link rel="prefetch" href="/assets/js/23.c6dbeed0.js"><link rel="prefetch" href="/assets/js/24.957b4252.js"><link rel="prefetch" href="/assets/js/25.b50e4879.js"><link rel="prefetch" href="/assets/js/26.1b2b16cf.js"><link rel="prefetch" href="/assets/js/27.2f0f5e4c.js"><link rel="prefetch" href="/assets/js/28.ffafaa79.js"><link rel="prefetch" href="/assets/js/29.38ab4732.js"><link rel="prefetch" href="/assets/js/30.7258c2eb.js"><link rel="prefetch" href="/assets/js/31.6cc6f25e.js"><link rel="prefetch" href="/assets/js/32.cae8f5c2.js"><link rel="prefetch" href="/assets/js/33.7bac5900.js"><link rel="prefetch" href="/assets/js/34.e457a7ab.js"><link rel="prefetch" href="/assets/js/35.6a4f99be.js"><link rel="prefetch" href="/assets/js/36.3fa7b425.js"><link rel="prefetch" href="/assets/js/37.9627a576.js"><link rel="prefetch" href="/assets/js/38.8f902270.js"><link rel="prefetch" href="/assets/js/39.2fb6b1fd.js"><link rel="prefetch" href="/assets/js/40.0f992849.js"><link rel="prefetch" href="/assets/js/41.1921a30c.js"><link rel="prefetch" href="/assets/js/42.196053b0.js"><link rel="prefetch" href="/assets/js/43.6a2cc6b2.js"><link rel="prefetch" href="/assets/js/44.c3b31b69.js"><link rel="prefetch" href="/assets/js/45.dd90e897.js"><link rel="prefetch" href="/assets/js/46.547a7ce9.js"><link rel="prefetch" href="/assets/js/47.a62be284.js"><link rel="prefetch" href="/assets/js/48.edc6618c.js"><link rel="prefetch" href="/assets/js/49.b3d5118e.js"><link rel="prefetch" href="/assets/js/50.81540475.js"><link rel="prefetch" href="/assets/js/51.c2c1171b.js"><link rel="prefetch" href="/assets/js/52.ba318094.js"><link rel="prefetch" href="/assets/js/53.a2d5d15e.js"><link rel="prefetch" href="/assets/js/54.3608cfdf.js"><link rel="prefetch" href="/assets/js/55.73c0d459.js"><link rel="prefetch" href="/assets/js/56.9706fe8c.js"><link rel="prefetch" href="/assets/js/57.f5a08e9a.js"><link rel="prefetch" href="/assets/js/58.ea9c9ad0.js"><link rel="prefetch" href="/assets/js/59.9d363669.js"><link rel="prefetch" href="/assets/js/60.8a80b28f.js"><link rel="prefetch" href="/assets/js/61.73e5c6a8.js"><link rel="prefetch" href="/assets/js/62.30aab875.js"><link rel="prefetch" href="/assets/js/63.1e86c5c0.js"><link rel="prefetch" href="/assets/js/64.9c071a1e.js"><link rel="prefetch" href="/assets/js/65.61d8d11c.js"><link rel="prefetch" href="/assets/js/66.dd39544e.js"><link rel="prefetch" href="/assets/js/67.6dd79cd2.js"><link rel="prefetch" href="/assets/js/68.dd07b2a3.js"><link rel="prefetch" href="/assets/js/69.a5a81dbc.js"><link rel="prefetch" href="/assets/js/70.3f26faed.js"><link rel="prefetch" href="/assets/js/71.1234830b.js"><link rel="prefetch" href="/assets/js/72.d4db7f16.js"><link rel="prefetch" href="/assets/js/73.e2b0a283.js"><link rel="prefetch" href="/assets/js/74.db6d3ebc.js"><link rel="prefetch" href="/assets/js/75.4516323c.js"><link rel="prefetch" href="/assets/js/76.a086fd94.js"><link rel="prefetch" href="/assets/js/77.165f6d28.js"><link rel="prefetch" href="/assets/js/78.81cd058e.js"><link rel="prefetch" href="/assets/js/79.fde8c00b.js"><link rel="prefetch" href="/assets/js/80.142b728c.js"><link rel="prefetch" href="/assets/js/81.367c9c5e.js"><link rel="prefetch" href="/assets/js/82.d23176e0.js"><link rel="prefetch" href="/assets/js/83.d9571f6f.js"><link rel="prefetch" href="/assets/js/84.6214056c.js"><link rel="prefetch" href="/assets/js/85.66cc6092.js"><link rel="prefetch" href="/assets/js/86.18dba812.js"><link rel="prefetch" href="/assets/js/87.9506d9f8.js"><link rel="prefetch" href="/assets/js/88.b42d6720.js"><link rel="prefetch" href="/assets/js/89.5c0033c4.js"><link rel="prefetch" href="/assets/js/90.069a50d4.js"><link rel="prefetch" href="/assets/js/91.61fe3c31.js"><link rel="prefetch" href="/assets/js/92.e4211585.js"><link rel="prefetch" href="/assets/js/93.6df74471.js"><link rel="prefetch" href="/assets/js/94.d61ebe6e.js"><link rel="prefetch" href="/assets/js/95.c60c8a69.js"><link rel="prefetch" href="/assets/js/96.e3124488.js"><link rel="prefetch" href="/assets/js/97.bce37e32.js"><link rel="prefetch" href="/assets/js/98.a1fb95ac.js"><link rel="prefetch" href="/assets/js/99.f9c12b84.js"><link rel="prefetch" href="/assets/js/100.0b3aaca9.js"><link rel="prefetch" href="/assets/js/101.03f32ae7.js"><link rel="prefetch" href="/assets/js/102.69cca032.js"><link rel="prefetch" href="/assets/js/103.190dc3ef.js"><link rel="prefetch" href="/assets/js/104.6e7ceda7.js"><link rel="prefetch" href="/assets/js/105.f852f5a7.js"><link rel="prefetch" href="/assets/js/106.9335f238.js"><link rel="prefetch" href="/assets/js/107.1404f516.js"><link rel="prefetch" href="/assets/js/108.dd6bb5e3.js"><link rel="prefetch" href="/assets/js/109.a87f5640.js"><link rel="prefetch" href="/assets/js/110.fb0da049.js"><link rel="prefetch" href="/assets/js/111.cc64ddd7.js"><link rel="prefetch" href="/assets/css/112.styles.75c39ee5.css"><link rel="prefetch" href="/assets/js/112.75c39ee5.js"><link rel="prefetch" href="/assets/css/113.styles.407e8d7f.css"><link rel="prefetch" href="/assets/js/113.407e8d7f.js">
    <link rel="stylesheet" href="/assets/css/112.styles.75c39ee5.css"><link rel="stylesheet" href="/assets/css/113.styles.407e8d7f.css"><link rel="stylesheet" href="/assets/css/styles.7863e8ac.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">油腻中年大叔</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/dart/" class="nav-link">Dart</a></div><div class="nav-item"><a href="/spring/" class="nav-link router-link-active">spring</a></div><div class="nav-item"><a href="/drools/" class="nav-link">规则和业务流程</a></div><div class="nav-item"><a href="/eip/" class="nav-link">EIP集成工具</a></div><div class="nav-item"><a href="/other/" class="nav-link">杂项</a></div><div class="nav-item"><a href="/algorithms/" class="nav-link">算法</a></div><div class="nav-item"><a href="/riding/" class="nav-link">骑行</a></div><div class="nav-item"><a href="/ev3/" class="nav-link">LEGO EV3 </a></div><div class="nav-item"><a href="/rubik/" class="nav-link">魔方</a></div><div class="nav-item"><a href="/mb/" class="nav-link">Micro:bit </a></div><div class="nav-item"><a href="/math/" class="nav-link">小学数学 </a></div><div class="nav-item"><a href="/eng/" class="nav-link">小学英语 </a></div><div class="nav-item"><a href="/jp/" class="nav-link">日语 </a></div><div class="nav-item"><a href="/gs1/" class="nav-link">GS-1</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/dart/" class="nav-link">Dart</a></div><div class="nav-item"><a href="/spring/" class="nav-link router-link-active">spring</a></div><div class="nav-item"><a href="/drools/" class="nav-link">规则和业务流程</a></div><div class="nav-item"><a href="/eip/" class="nav-link">EIP集成工具</a></div><div class="nav-item"><a href="/other/" class="nav-link">杂项</a></div><div class="nav-item"><a href="/algorithms/" class="nav-link">算法</a></div><div class="nav-item"><a href="/riding/" class="nav-link">骑行</a></div><div class="nav-item"><a href="/ev3/" class="nav-link">LEGO EV3 </a></div><div class="nav-item"><a href="/rubik/" class="nav-link">魔方</a></div><div class="nav-item"><a href="/mb/" class="nav-link">Micro:bit </a></div><div class="nav-item"><a href="/math/" class="nav-link">小学数学 </a></div><div class="nav-item"><a href="/eng/" class="nav-link">小学英语 </a></div><div class="nav-item"><a href="/jp/" class="nav-link">日语 </a></div><div class="nav-item"><a href="/gs1/" class="nav-link">GS-1</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/spring/writetofile.html" class="sidebar-link">JavaIO-DataoutPut</a></li><li><a href="/spring/java-classloader.html" class="sidebar-link">java类加载器</a></li><li><a href="/spring/jvm-stack.html" class="sidebar-link">jvm 相关</a></li><li><a href="/spring/annotation.html" class="sidebar-link">注解的使用</a></li><li><a href="/spring/SpringAnnotations.html" class="sidebar-link">Spring注解速查</a></li><li><a href="/spring/springboot.html" class="sidebar-link">Springboot 配置速查</a></li><li><a href="/spring/springbootRun.html" class="sidebar-link">Springboot启动过程</a></li><li><a href="/spring/springboot-gitlab-ci.html" class="sidebar-link">Springboot基于Gitlab持续集成</a></li><li><a href="/spring/SpringBootTesting.html" class="sidebar-link">SpringBoot 测试</a></li><li><a href="/spring/SpringbootTesting2.html" class="sidebar-link">SpringBoot 测试建议</a></li><li><a href="/spring/TestingControllersInSpringboot.html" class="sidebar-link">SpringBoot的Contoller测试</a></li><li><a href="/spring/JacksonObjectMapperCheetSheet.html" class="sidebar-link">Jackson ObjectMapper CheetSheet</a></li><li><a href="/spring/lock.html" class="sidebar-link">占用bug分析</a></li><li><a href="/spring/singleton-scope.html" class="active sidebar-link">Spring MVC 并发与线程安全</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/spring/singleton-scope.html#controller-是否线程安全" class="sidebar-link">Controller 是否线程安全</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/spring/singleton-scope.html#案例1-contoller对象属性操作" class="sidebar-link">案例1- Contoller对象属性操作</a></li><li class="sidebar-sub-header"><a href="/spring/singleton-scope.html#案例2-contoller对象属性加volatile" class="sidebar-link">案例2-Contoller对象属性加volatile</a></li><li class="sidebar-sub-header"><a href="/spring/singleton-scope.html#案例3-contoller对象属性-volatile-integer" class="sidebar-link">案例3-Contoller对象属性: volatile + integer</a></li><li class="sidebar-sub-header"><a href="/spring/singleton-scope.html#案例4-synchronized-关键字" class="sidebar-link">案例4-synchronized 关键字</a></li><li class="sidebar-sub-header"><a href="/spring/singleton-scope.html#案例5-synchronized修饰代码段" class="sidebar-link">案例5-synchronized修饰代码段</a></li><li class="sidebar-sub-header"><a href="/spring/singleton-scope.html#案例6-使用atomicinteger" class="sidebar-link">案例6-使用AtomicInteger</a></li></ul></li><li class="sidebar-sub-header"><a href="/spring/singleton-scope.html#使用spring托管的service-bean是否线程安全" class="sidebar-link">使用Spring托管的Service Bean是否线程安全</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/spring/singleton-scope.html#案例7-service-bean" class="sidebar-link">案例7-Service Bean</a></li><li class="sidebar-sub-header"><a href="/spring/singleton-scope.html#案例8-synchronized" class="sidebar-link">案例8-synchronized</a></li><li class="sidebar-sub-header"><a href="/spring/singleton-scope.html#案例9-atomicinteger" class="sidebar-link">案例9-AtomicInteger</a></li><li class="sidebar-sub-header"><a href="/spring/singleton-scope.html#案例10-模拟数据库访问" class="sidebar-link">案例10-模拟数据库访问</a></li></ul></li><li class="sidebar-sub-header"><a href="/spring/singleton-scope.html#多jvm-集群环境-分布式" class="sidebar-link">多JVM/集群环境/分布式</a></li></ul></li><li><a href="/spring/singleton.html" class="sidebar-link">设计模式-单件</a></li></ul> </div> <div class="page"> <div class="content"><h2 id="controller-是否线程安全"><a href="#controller-是否线程安全" aria-hidden="true" class="header-anchor">#</a> Controller 是否线程安全</h2> <h3 id="案例1-contoller对象属性操作"><a href="#案例1-contoller对象属性操作" aria-hidden="true" class="header-anchor">#</a> 案例1- Contoller对象属性操作</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/unsafe&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UnsafeController</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Logger logger <span class="token operator">=</span> LoggerFactory<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span>UnsafeController<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/index&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        count<span class="token operator">++</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Unsafe Controller count should be:&quot;</span> <span class="token operator">+</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;unsafe&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>2021-01-02 07:33:03.749  INFO 3183 --- <span class="token punctuation">[</span>nio-8080-exec-3<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:2
2021-01-02 07:33:03.749  INFO 3183 --- <span class="token punctuation">[</span>nio-8080-exec-7<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:3
2021-01-02 07:33:03.750  INFO 3183 --- <span class="token punctuation">[</span>nio-8080-exec-2<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:5
2021-01-02 07:33:03.750  INFO 3183 --- <span class="token punctuation">[</span>nio-8080-exec-8<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:6
2021-01-02 07:33:03.751  INFO 3183 --- <span class="token punctuation">[</span>io-8080-exec-10<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:7
2021-01-02 07:33:03.751  INFO 3183 --- <span class="token punctuation">[</span>nio-8080-exec-9<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:8
2021-01-02 07:33:03.750  INFO 3183 --- <span class="token punctuation">[</span>nio-8080-exec-6<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:4
2021-01-02 07:33:03.752  INFO 3183 --- <span class="token punctuation">[</span>nio-8080-exec-4<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:9
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
2021-01-02 07:33:03.867  INFO 3183 --- <span class="token punctuation">[</span>nio-8080-exec-7<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:92
2021-01-02 07:33:03.867  INFO 3183 --- <span class="token punctuation">[</span>nio-8080-exec-9<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:92
2021-01-02 07:33:03.867  INFO 3183 --- <span class="token punctuation">[</span>nio-8080-exec-6<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:94
2021-01-02 07:33:03.867  INFO 3183 --- <span class="token punctuation">[</span>nio-8080-exec-2<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:92
2021-01-02 07:33:03.868  INFO 3183 --- <span class="token punctuation">[</span>nio-8080-exec-1<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:95
2021-01-02 07:33:03.869  INFO 3183 --- <span class="token punctuation">[</span>io-8080-exec-10<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:96
2021-01-02 07:33:03.870  INFO 3183 --- <span class="token punctuation">[</span>nio-8080-exec-3<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:97
2021-01-02 07:33:03.873  INFO 3183 --- <span class="token punctuation">[</span>nio-8080-exec-7<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:98
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="案例2-contoller对象属性加volatile"><a href="#案例2-contoller对象属性加volatile" aria-hidden="true" class="header-anchor">#</a> 案例2-Contoller对象属性加volatile</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/unsafe&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UnsafeController</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Logger logger <span class="token operator">=</span> LoggerFactory<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span>UnsafeController<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/index&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        count<span class="token operator">++</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Unsafe Controller count should be:&quot;</span> <span class="token operator">+</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;unsafe&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>ab -n 100 -c 10 http://localhost:8080/unsafe/index
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>2021-01-02 10:57:15.117  INFO 5680 --- <span class="token punctuation">[</span>io-8080-exec-10<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:86
2021-01-02 10:57:15.119  INFO 5680 --- <span class="token punctuation">[</span>nio-8080-exec-6<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:89
2021-01-02 10:57:15.119  INFO 5680 --- <span class="token punctuation">[</span>nio-8080-exec-5<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:90
2021-01-02 10:57:15.119  INFO 5680 --- <span class="token punctuation">[</span>nio-8080-exec-9<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:88
2021-01-02 10:57:15.119  INFO 5680 --- <span class="token punctuation">[</span>nio-8080-exec-3<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:91
2021-01-02 10:57:15.119  INFO 5680 --- <span class="token punctuation">[</span>nio-8080-exec-7<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:92
2021-01-02 10:57:15.119  INFO 5680 --- <span class="token punctuation">[</span>nio-8080-exec-4<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:93
2021-01-02 10:57:15.119  INFO 5680 --- <span class="token punctuation">[</span>nio-8080-exec-1<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:94

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>volatile关键字能保证可见性,可见性只能保证每次读取的是最新的值，但是volatile没办法保证对变量的操作的原子性。所以最终输出并不是100.</p> <h3 id="案例3-contoller对象属性-volatile-integer"><a href="#案例3-contoller对象属性-volatile-integer" aria-hidden="true" class="header-anchor">#</a> 案例3-Contoller对象属性: volatile + integer</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/unsafe&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UnsafeController</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Logger logger <span class="token operator">=</span> LoggerFactory<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span>UnsafeController<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span>  <span class="token keyword">volatile</span> Integer count <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/index&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span>  String <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        count<span class="token operator">++</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Unsafe Controller count should be:&quot;</span> <span class="token operator">+</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;unsafe&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>ab -n 100 -c 10 http://localhost:8080/unsafe/index
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>2021-01-02 10:58:34.622  INFO 5711 --- <span class="token punctuation">[</span>nio-8080-exec-6<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:89
2021-01-02 10:58:34.623  INFO 5711 --- <span class="token punctuation">[</span>nio-8080-exec-2<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:90
2021-01-02 10:58:34.624  INFO 5711 --- <span class="token punctuation">[</span>io-8080-exec-10<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:91
2021-01-02 10:58:34.624  INFO 5711 --- <span class="token punctuation">[</span>nio-8080-exec-9<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:92
2021-01-02 10:58:34.624  INFO 5711 --- <span class="token punctuation">[</span>nio-8080-exec-1<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:93
2021-01-02 10:58:34.623  INFO 5711 --- <span class="token punctuation">[</span>nio-8080-exec-3<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:90
2021-01-02 10:58:34.625  INFO 5711 --- <span class="token punctuation">[</span>nio-8080-exec-8<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:94
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>同样Integer也不是线程安全的方法，不能保证最终结果是100。</p> <h3 id="案例4-synchronized-关键字"><a href="#案例4-synchronized-关键字" aria-hidden="true" class="header-anchor">#</a> 案例4-synchronized 关键字</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/unsafe&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UnsafeController</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Logger logger <span class="token operator">=</span> LoggerFactory<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span>UnsafeController<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span>  <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/index&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> String <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        count<span class="token operator">++</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Unsafe Controller count should be:&quot;</span> <span class="token operator">+</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;unsafe&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>2021-01-02 10:49:11.664  INFO 5450 --- <span class="token punctuation">[</span>nio-8080-exec-7<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:94
2021-01-02 10:49:11.665  INFO 5450 --- <span class="token punctuation">[</span>nio-8080-exec-3<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:95
2021-01-02 10:49:11.668  INFO 5450 --- <span class="token punctuation">[</span>nio-8080-exec-9<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:96
2021-01-02 10:49:11.669  INFO 5450 --- <span class="token punctuation">[</span>nio-8080-exec-4<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:97
2021-01-02 10:49:11.669  INFO 5450 --- <span class="token punctuation">[</span>nio-8080-exec-1<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:98
2021-01-02 10:49:11.670  INFO 5450 --- <span class="token punctuation">[</span>nio-8080-exec-2<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:99
2021-01-02 10:49:11.670  INFO 5450 --- <span class="token punctuation">[</span>nio-8080-exec-7<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:100
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="案例5-synchronized修饰代码段"><a href="#案例5-synchronized修饰代码段" aria-hidden="true" class="header-anchor">#</a> 案例5-synchronized修饰代码段</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/unsafe&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UnsafeController</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Logger logger <span class="token operator">=</span> LoggerFactory<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span>UnsafeController<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span>  Integer count <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/index&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span>  String <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            count<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Unsafe Controller count should be:&quot;</span> <span class="token operator">+</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;unsafe&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>ab -n 1000 -c 10 http://localhost:8080/unsafe/index
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>2021-01-02 10:53:28.234  INFO 5609 --- <span class="token punctuation">[</span>nio-8080-exec-2<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:998
2021-01-02 10:53:28.234  INFO 5609 --- <span class="token punctuation">[</span>nio-8080-exec-4<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:997
2021-01-02 10:53:28.234  INFO 5609 --- <span class="token punctuation">[</span>nio-8080-exec-1<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:997
2021-01-02 10:53:28.234  INFO 5609 --- <span class="token punctuation">[</span>nio-8080-exec-8<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:999
2021-01-02 10:53:28.235  INFO 5609 --- <span class="token punctuation">[</span>nio-8080-exec-9<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> Unsafe Controller count should be:1000

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="案例6-使用atomicinteger"><a href="#案例6-使用atomicinteger" aria-hidden="true" class="header-anchor">#</a> 案例6-使用AtomicInteger</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/unsafe&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UnsafeController</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Logger logger <span class="token operator">=</span> LoggerFactory<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span>UnsafeController<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> AtomicInteger count <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/index&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        count<span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Unsafe Controller count should be:&quot;</span> <span class="token operator">+</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;unsafe&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>ab -n 10000 -c 50 http://localhost:8080/unsafe/index
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="使用spring托管的service-bean是否线程安全"><a href="#使用spring托管的service-bean是否线程安全" aria-hidden="true" class="header-anchor">#</a> 使用Spring托管的Service Bean是否线程安全</h2> <p>我们常说Spring托管的bean是singleton的，那么如果把逻辑放入一个bean，然后在controller引用这个bean，会解决并发，保证原子性吗？</p> <p>答案是否定的。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SumBean</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">plus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cnt<span class="token operator">++</span> <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCnt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> cnt<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="案例7-service-bean"><a href="#案例7-service-bean" aria-hidden="true" class="header-anchor">#</a> 案例7-Service Bean</h3> <p>我们新建一个contoller方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/sum&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> String <span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sum<span class="token punctuation">.</span><span class="token function">plus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Sum Bean count should be:&quot;</span> <span class="token operator">+</span> sum<span class="token punctuation">.</span><span class="token function">getCnt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;sum&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-text"><code> ab -n 100 -c 10 http://localhost:8080/unsafe/sum
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-text"><code>2021-01-02 11:44:09.006  INFO 6606 --- [nio-8080-exec-5] c.f.s.t.controller.UnsafeController      : Sum Bean count should be:92
2021-01-02 11:44:09.006  INFO 6606 --- [io-8080-exec-10] c.f.s.t.controller.UnsafeController      : Sum Bean count should be:93
2021-01-02 11:44:09.007  INFO 6606 --- [nio-8080-exec-7] c.f.s.t.controller.UnsafeController      : Sum Bean count should be:94
2021-01-02 11:44:09.007  INFO 6606 --- [nio-8080-exec-6] c.f.s.t.controller.UnsafeController      : Sum Bean count should be:95
2021-01-02 11:44:09.009  INFO 6606 --- [nio-8080-exec-4] c.f.s.t.controller.UnsafeController      : Sum Bean count should be:96
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>残念ですが</p> <p>程序并没有输出我们期待的100。其实与放在controller里一样.Spring mvc是一个多线程的环境，线程之间修改共享的对象或者属性，是非常危险的。</p> <p>Spring容器会初始化一个DispatcherServlet实例。容器同样管理着一个线程池用于响应HTTP连接。当一个请求来的时候，容器从线程池中拿出一个线程，执行service()方法，把请求转发给正确的@Controller实例。</p> <p>所以，如果我们保证Sumbean的原子性操作</p> <h3 id="案例8-synchronized"><a href="#案例8-synchronized" aria-hidden="true" class="header-anchor">#</a> 案例8-synchronized</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SumBean</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span>  <span class="token keyword">final</span> Logger logger <span class="token operator">=</span> LoggerFactory<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span>SumBean<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">plus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cnt<span class="token operator">++</span> <span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Sum Bean count should be:&quot;</span> <span class="token operator">+</span> cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCnt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> cnt<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="案例9-atomicinteger"><a href="#案例9-atomicinteger" aria-hidden="true" class="header-anchor">#</a> 案例9-AtomicInteger</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SumBean</span> <span class="token punctuation">{</span>
    <span class="token comment">//private int cnt = 0;</span>
    <span class="token keyword">private</span> AtomicInteger cnt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span>  <span class="token keyword">final</span> Logger logger <span class="token operator">=</span> LoggerFactory<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span>SumBean<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span>  <span class="token keyword">void</span> <span class="token function">plus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cnt<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Sum Bean count should be:&quot;</span> <span class="token operator">+</span> cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCnt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> cnt<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="案例10-模拟数据库访问"><a href="#案例10-模拟数据库访问" aria-hidden="true" class="header-anchor">#</a> 案例10-模拟数据库访问</h3> <p>在这个案例中，我们模拟一个数据库应用，扣减库存。</p> <ul><li>向Contoller发起请求，每次请求扣减1个库存。系统初始化为10000.</li> <li>Service负责计算库存，并调用DAO保存。
我们预想中使用的库存和可用库存的总数量应该为10000.</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token comment">/**
*模拟DAO
*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InventoryDAO</span> <span class="token punctuation">{</span>
	<span class="token comment">//库存初始化为10000</span>
    <span class="token keyword">private</span> Integer availableStock<span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> Integer usedStock <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> Integer <span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>availableStock<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setStock</span><span class="token punctuation">(</span>Integer qty<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>availableStock <span class="token operator">=</span> qty<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUsedStock</span><span class="token punctuation">(</span>Integer qty<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>usedStock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usedStock <span class="token operator">+</span> qty<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Integer <span class="token function">getUsedStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usedStock<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Service</span>
<span class="token comment">/*
*业务逻辑
*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Inventory</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    InventoryDAO inventoryDAO<span class="token punctuation">;</span>

    <span class="token keyword">private</span>  <span class="token keyword">final</span> Logger logger <span class="token operator">=</span> LoggerFactory<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span>Inventory<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//扣减库存</span>
    <span class="token keyword">public</span>  <span class="token keyword">void</span> <span class="token function">allocateStock</span><span class="token punctuation">(</span><span class="token keyword">int</span> qty<span class="token punctuation">)</span><span class="token punctuation">{</span>
        Integer newQty<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>inventoryDAO<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;=</span> qty<span class="token punctuation">)</span><span class="token punctuation">{</span>
            newQty <span class="token operator">=</span> inventoryDAO<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> qty<span class="token punctuation">;</span>
            inventoryDAO<span class="token punctuation">.</span><span class="token function">setStock</span><span class="token punctuation">(</span>newQty<span class="token punctuation">)</span><span class="token punctuation">;</span>
            inventoryDAO<span class="token punctuation">.</span><span class="token function">setUsedStock</span><span class="token punctuation">(</span>qty<span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Stock left/Stock used: &quot;</span><span class="token operator">+</span> inventoryDAO<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> inventoryDAO<span class="token punctuation">.</span><span class="token function">getUsedStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Stock not Available&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> inventoryDAO<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getUsedStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> inventoryDAO<span class="token punctuation">.</span><span class="token function">getUsedStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Controller</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/unsafe&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UnsafeController</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Logger logger <span class="token operator">=</span> LoggerFactory<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span>UnsafeController<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> Inventory inventory<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;inv&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token comment">//每次扣减1个</span>
    <span class="token keyword">public</span>  String <span class="token function">inv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">int</span> qty <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        inventory<span class="token punctuation">.</span><span class="token function">allocateStock</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;used stock should be: &quot;</span> <span class="token operator">+</span> inventory<span class="token punctuation">.</span><span class="token function">getUsedStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;inv&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br></div></div><p>总共发起100个请求，并发为10</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>ab -n 100 -c 10 http://localhost:8080/unsafe/inv
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>按照预期，最终使用的使用库存数和库存余数和应该为10000，使用库存应该为100，预存余数应该为9900</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>2021-01-02 16:01:41.466  INFO 10680 --- <span class="token punctuation">[</span>nio-8080-exec-1<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> used stock should be: 84
2021-01-02 16:01:41.466  INFO 10680 --- <span class="token punctuation">[</span>io-8080-exec-10<span class="token punctuation">]</span> c.f.sample.threadsafe.service.Inventory  <span class="token keyword">:</span> Stock left/Stock used: 9914/86
2021-01-02 16:01:41.466  INFO 10680 --- <span class="token punctuation">[</span>nio-8080-exec-8<span class="token punctuation">]</span> c.f.sample.threadsafe.service.Inventory  <span class="token keyword">:</span> Stock left/Stock used: 9915/85
2021-01-02 16:01:41.466  INFO 10680 --- <span class="token punctuation">[</span>nio-8080-exec-5<span class="token punctuation">]</span> c.f.sample.threadsafe.service.Inventory  <span class="token keyword">:</span> Stock left/Stock used: 9913/87
2021-01-02 16:01:41.466  INFO 10680 --- <span class="token punctuation">[</span>io-8080-exec-10<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> used stock should be: 87
2021-01-02 16:01:41.466  INFO 10680 --- <span class="token punctuation">[</span>nio-8080-exec-8<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> used stock should be: 87
2021-01-02 16:01:41.466  INFO 10680 --- <span class="token punctuation">[</span>nio-8080-exec-5<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> used stock should be: 87
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>多次执行，我们发现，使用库存数几乎都不是100.</p> <h4 id="如何保证线程安全"><a href="#如何保证线程安全" aria-hidden="true" class="header-anchor">#</a> 如何保证线程安全</h4> <p>与之前的例子一样，我们可以使用synchronized方式来改造上述代码。</p> <p>除此以外还可以使用ReentranLock。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Inventory</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    InventoryDAO inventoryDAO<span class="token punctuation">;</span>

    <span class="token keyword">private</span>  Lock lock<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">Inventory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span>  <span class="token keyword">final</span> Logger logger <span class="token operator">=</span> LoggerFactory<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span>Inventory<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span>  <span class="token keyword">void</span> <span class="token function">allocateStock</span><span class="token punctuation">(</span><span class="token keyword">int</span> qty<span class="token punctuation">)</span><span class="token punctuation">{</span>
        Integer newQty<span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>inventoryDAO<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> qty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                newQty <span class="token operator">=</span> inventoryDAO<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> qty<span class="token punctuation">;</span>
                inventoryDAO<span class="token punctuation">.</span><span class="token function">setStock</span><span class="token punctuation">(</span>newQty<span class="token punctuation">)</span><span class="token punctuation">;</span>
                inventoryDAO<span class="token punctuation">.</span><span class="token function">setUsedStock</span><span class="token punctuation">(</span>qty<span class="token punctuation">)</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Stock left/Stock used: &quot;</span> <span class="token operator">+</span> inventoryDAO<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> inventoryDAO<span class="token punctuation">.</span><span class="token function">getUsedStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Stock not Available&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> inventoryDAO<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getUsedStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> inventoryDAO<span class="token punctuation">.</span><span class="token function">getUsedStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>执行测试</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>ab -n 100 -c 10 http://localhost:8080/unsafe/inv
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>2021-01-02 20:47:16.057  INFO 13090 --- <span class="token punctuation">[</span>nio-8080-exec-7<span class="token punctuation">]</span> c.f.sample.threadsafe.service.Inventory  <span class="token keyword">:</span> Stock left/Stock used: 9903/97
2021-01-02 20:47:16.057  INFO 13090 --- <span class="token punctuation">[</span>nio-8080-exec-7<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> used stock should be: 97
2021-01-02 20:47:16.057  INFO 13090 --- <span class="token punctuation">[</span>nio-8080-exec-8<span class="token punctuation">]</span> c.f.sample.threadsafe.service.Inventory  <span class="token keyword">:</span> Stock left/Stock used: 9902/98
2021-01-02 20:47:16.057  INFO 13090 --- <span class="token punctuation">[</span>nio-8080-exec-8<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> used stock should be: 98
2021-01-02 20:47:16.059  INFO 13090 --- <span class="token punctuation">[</span>nio-8080-exec-9<span class="token punctuation">]</span> c.f.sample.threadsafe.service.Inventory  <span class="token keyword">:</span> Stock left/Stock used: 9901/99
2021-01-02 20:47:16.059  INFO 13090 --- <span class="token punctuation">[</span>nio-8080-exec-9<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> used stock should be: 99
2021-01-02 20:47:16.059  INFO 13090 --- <span class="token punctuation">[</span>io-8080-exec-10<span class="token punctuation">]</span> c.f.sample.threadsafe.service.Inventory  <span class="token keyword">:</span> Stock left/Stock used: 9900/100
2021-01-02 20:47:16.059  INFO 13090 --- <span class="token punctuation">[</span>io-8080-exec-10<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> used stock should be: 100
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
 2021-01-02 20:47:24.693  INFO 13090 --- <span class="token punctuation">[</span>nio-8080-exec-5<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> used stock should be: 197
2021-01-02 20:47:24.695  INFO 13090 --- <span class="token punctuation">[</span>io-8080-exec-10<span class="token punctuation">]</span> c.f.sample.threadsafe.service.Inventory  <span class="token keyword">:</span> Stock left/Stock used: 9802/198
2021-01-02 20:47:24.695  INFO 13090 --- <span class="token punctuation">[</span>io-8080-exec-10<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> used stock should be: 198
2021-01-02 20:47:24.695  INFO 13090 --- <span class="token punctuation">[</span>nio-8080-exec-7<span class="token punctuation">]</span> c.f.sample.threadsafe.service.Inventory  <span class="token keyword">:</span> Stock left/Stock used: 9801/199
2021-01-02 20:47:24.695  INFO 13090 --- <span class="token punctuation">[</span>nio-8080-exec-7<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> used stock should be: 199
2021-01-02 20:47:24.697  INFO 13090 --- <span class="token punctuation">[</span>nio-8080-exec-1<span class="token punctuation">]</span> c.f.sample.threadsafe.service.Inventory  <span class="token keyword">:</span> Stock left/Stock used: 9800/200
2021-01-02 20:47:24.697  INFO 13090 --- <span class="token punctuation">[</span>nio-8080-exec-1<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> used stock should be: 200
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
2021-01-02 20:47:29.751  INFO 13090 --- <span class="token punctuation">[</span>nio-8080-exec-1<span class="token punctuation">]</span> c.f.sample.threadsafe.service.Inventory  <span class="token keyword">:</span> Stock left/Stock used: 9702/298
2021-01-02 20:47:29.751  INFO 13090 --- <span class="token punctuation">[</span>nio-8080-exec-1<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> used stock should be: 298
2021-01-02 20:47:29.751  INFO 13090 --- <span class="token punctuation">[</span>io-8080-exec-10<span class="token punctuation">]</span> c.f.sample.threadsafe.service.Inventory  <span class="token keyword">:</span> Stock left/Stock used: 9701/299
2021-01-02 20:47:29.751  INFO 13090 --- <span class="token punctuation">[</span>io-8080-exec-10<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> used stock should be: 299
2021-01-02 20:47:29.753  INFO 13090 --- <span class="token punctuation">[</span>nio-8080-exec-9<span class="token punctuation">]</span> c.f.sample.threadsafe.service.Inventory  <span class="token keyword">:</span> Stock left/Stock used: 9700/300
2021-01-02 20:47:29.753  INFO 13090 --- <span class="token punctuation">[</span>nio-8080-exec-9<span class="token punctuation">]</span> c.f.s.t.controller.UnsafeController      <span class="token keyword">:</span> used stock should be: 300
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    method body
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>与下面这段代码等价。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>intrinsicLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        method body
    <span class="token punctuation">}</span>
    <span class="token keyword">finally</span> <span class="token punctuation">{</span> 
        <span class="token keyword">this</span><span class="token punctuation">.</span>intrinsicLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>另外一般情况下（例如单体应用，一个JVM），考虑Core Java一书给出的建议</p> <ul><li>It is best to use neither Lock/Condition nor the synchronized
keyword. In many situations, you can use one of the mechanisms of the
java.util.concurrent package that do all the locking for you.
For example, in Section 12.5.1, “Blocking Queues,” on p. 781, you will
see how to use a blocking queue to synchronize threads that work on a
common task. You should also explore parallel streams—see Chapter 1
of Volume II.</li> <li>If the synchronized keyword works for your situation, by all means,
use it. You’ll write less code and have less room for error. Listing 12.5
shows the bank example, implemented with synchronized methods.</li> <li>Use Lock/Condition if you really need the additional power that
these constructs give you.</li></ul> <h2 id="多jvm-集群环境-分布式"><a href="#多jvm-集群环境-分布式" aria-hidden="true" class="header-anchor">#</a> 多JVM/集群环境/分布式</h2> <p>synchronized也好或者AtomicInteger也好，只能保证在同一个JVM中的线程安全。</p> <p>如果在分布式环境下，要读取操作同样一份数据，就要更妥善的考虑。</p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/spring/lock.html" class="prev">
          占用bug分析
        </a></span> <span class="next"><a href="/spring/singleton.html">
          设计模式-单件
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/6.0d0d8441.js" defer></script><script src="/assets/js/app.7863e8ac.js" defer></script>
  </body>
</html>
