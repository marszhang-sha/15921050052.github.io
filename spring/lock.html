<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一起深度bug分析 | 油腻中年大叔</title>
    <meta name="description" content="你想要的这里都没有，你不想要的这里都有">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/github-markdown-css/2.2.1/github-markdown.css">
    
    <link rel="preload" href="/assets/css/styles.7863e8ac.css" as="style"><link rel="preload" href="/assets/js/app.7863e8ac.js" as="script"><link rel="preload" href="/assets/js/8.5752a787.js" as="script"><link rel="prefetch" href="/assets/js/0.eb7108e7.js"><link rel="prefetch" href="/assets/js/1.d8ec4d72.js"><link rel="prefetch" href="/assets/js/2.28f90b8d.js"><link rel="prefetch" href="/assets/js/3.6001361f.js"><link rel="prefetch" href="/assets/js/4.80c27a58.js"><link rel="prefetch" href="/assets/js/5.2e2f809b.js"><link rel="prefetch" href="/assets/js/6.0d0d8441.js"><link rel="prefetch" href="/assets/js/7.8e4037c3.js"><link rel="prefetch" href="/assets/js/9.8329deb8.js"><link rel="prefetch" href="/assets/js/10.4843c5ba.js"><link rel="prefetch" href="/assets/js/11.9e8b7549.js"><link rel="prefetch" href="/assets/js/12.02c0fa30.js"><link rel="prefetch" href="/assets/js/13.f5d738e8.js"><link rel="prefetch" href="/assets/js/14.ca4b3249.js"><link rel="prefetch" href="/assets/js/15.cf61b2ec.js"><link rel="prefetch" href="/assets/js/16.2b67aa0e.js"><link rel="prefetch" href="/assets/js/17.b99a459f.js"><link rel="prefetch" href="/assets/js/18.2d5afa9a.js"><link rel="prefetch" href="/assets/js/19.6c36dff4.js"><link rel="prefetch" href="/assets/js/20.3e0dc870.js"><link rel="prefetch" href="/assets/js/21.227ee5ec.js"><link rel="prefetch" href="/assets/js/22.05c1f0f0.js"><link rel="prefetch" href="/assets/js/23.c6dbeed0.js"><link rel="prefetch" href="/assets/js/24.957b4252.js"><link rel="prefetch" href="/assets/js/25.b50e4879.js"><link rel="prefetch" href="/assets/js/26.1b2b16cf.js"><link rel="prefetch" href="/assets/js/27.2f0f5e4c.js"><link rel="prefetch" href="/assets/js/28.ffafaa79.js"><link rel="prefetch" href="/assets/js/29.38ab4732.js"><link rel="prefetch" href="/assets/js/30.7258c2eb.js"><link rel="prefetch" href="/assets/js/31.6cc6f25e.js"><link rel="prefetch" href="/assets/js/32.cae8f5c2.js"><link rel="prefetch" href="/assets/js/33.7bac5900.js"><link rel="prefetch" href="/assets/js/34.e457a7ab.js"><link rel="prefetch" href="/assets/js/35.6a4f99be.js"><link rel="prefetch" href="/assets/js/36.3fa7b425.js"><link rel="prefetch" href="/assets/js/37.9627a576.js"><link rel="prefetch" href="/assets/js/38.8f902270.js"><link rel="prefetch" href="/assets/js/39.2fb6b1fd.js"><link rel="prefetch" href="/assets/js/40.0f992849.js"><link rel="prefetch" href="/assets/js/41.1921a30c.js"><link rel="prefetch" href="/assets/js/42.196053b0.js"><link rel="prefetch" href="/assets/js/43.6a2cc6b2.js"><link rel="prefetch" href="/assets/js/44.c3b31b69.js"><link rel="prefetch" href="/assets/js/45.dd90e897.js"><link rel="prefetch" href="/assets/js/46.547a7ce9.js"><link rel="prefetch" href="/assets/js/47.a62be284.js"><link rel="prefetch" href="/assets/js/48.edc6618c.js"><link rel="prefetch" href="/assets/js/49.b3d5118e.js"><link rel="prefetch" href="/assets/js/50.81540475.js"><link rel="prefetch" href="/assets/js/51.c2c1171b.js"><link rel="prefetch" href="/assets/js/52.ba318094.js"><link rel="prefetch" href="/assets/js/53.a2d5d15e.js"><link rel="prefetch" href="/assets/js/54.3608cfdf.js"><link rel="prefetch" href="/assets/js/55.73c0d459.js"><link rel="prefetch" href="/assets/js/56.9706fe8c.js"><link rel="prefetch" href="/assets/js/57.f5a08e9a.js"><link rel="prefetch" href="/assets/js/58.ea9c9ad0.js"><link rel="prefetch" href="/assets/js/59.9d363669.js"><link rel="prefetch" href="/assets/js/60.8a80b28f.js"><link rel="prefetch" href="/assets/js/61.73e5c6a8.js"><link rel="prefetch" href="/assets/js/62.30aab875.js"><link rel="prefetch" href="/assets/js/63.1e86c5c0.js"><link rel="prefetch" href="/assets/js/64.9c071a1e.js"><link rel="prefetch" href="/assets/js/65.61d8d11c.js"><link rel="prefetch" href="/assets/js/66.dd39544e.js"><link rel="prefetch" href="/assets/js/67.6dd79cd2.js"><link rel="prefetch" href="/assets/js/68.dd07b2a3.js"><link rel="prefetch" href="/assets/js/69.a5a81dbc.js"><link rel="prefetch" href="/assets/js/70.3f26faed.js"><link rel="prefetch" href="/assets/js/71.1234830b.js"><link rel="prefetch" href="/assets/js/72.d4db7f16.js"><link rel="prefetch" href="/assets/js/73.e2b0a283.js"><link rel="prefetch" href="/assets/js/74.db6d3ebc.js"><link rel="prefetch" href="/assets/js/75.4516323c.js"><link rel="prefetch" href="/assets/js/76.a086fd94.js"><link rel="prefetch" href="/assets/js/77.165f6d28.js"><link rel="prefetch" href="/assets/js/78.81cd058e.js"><link rel="prefetch" href="/assets/js/79.fde8c00b.js"><link rel="prefetch" href="/assets/js/80.142b728c.js"><link rel="prefetch" href="/assets/js/81.367c9c5e.js"><link rel="prefetch" href="/assets/js/82.d23176e0.js"><link rel="prefetch" href="/assets/js/83.d9571f6f.js"><link rel="prefetch" href="/assets/js/84.6214056c.js"><link rel="prefetch" href="/assets/js/85.66cc6092.js"><link rel="prefetch" href="/assets/js/86.18dba812.js"><link rel="prefetch" href="/assets/js/87.9506d9f8.js"><link rel="prefetch" href="/assets/js/88.b42d6720.js"><link rel="prefetch" href="/assets/js/89.5c0033c4.js"><link rel="prefetch" href="/assets/js/90.069a50d4.js"><link rel="prefetch" href="/assets/js/91.61fe3c31.js"><link rel="prefetch" href="/assets/js/92.e4211585.js"><link rel="prefetch" href="/assets/js/93.6df74471.js"><link rel="prefetch" href="/assets/js/94.d61ebe6e.js"><link rel="prefetch" href="/assets/js/95.c60c8a69.js"><link rel="prefetch" href="/assets/js/96.e3124488.js"><link rel="prefetch" href="/assets/js/97.bce37e32.js"><link rel="prefetch" href="/assets/js/98.a1fb95ac.js"><link rel="prefetch" href="/assets/js/99.f9c12b84.js"><link rel="prefetch" href="/assets/js/100.0b3aaca9.js"><link rel="prefetch" href="/assets/js/101.03f32ae7.js"><link rel="prefetch" href="/assets/js/102.69cca032.js"><link rel="prefetch" href="/assets/js/103.190dc3ef.js"><link rel="prefetch" href="/assets/js/104.6e7ceda7.js"><link rel="prefetch" href="/assets/js/105.f852f5a7.js"><link rel="prefetch" href="/assets/js/106.9335f238.js"><link rel="prefetch" href="/assets/js/107.1404f516.js"><link rel="prefetch" href="/assets/js/108.dd6bb5e3.js"><link rel="prefetch" href="/assets/js/109.a87f5640.js"><link rel="prefetch" href="/assets/js/110.fb0da049.js"><link rel="prefetch" href="/assets/js/111.cc64ddd7.js"><link rel="prefetch" href="/assets/css/112.styles.75c39ee5.css"><link rel="prefetch" href="/assets/js/112.75c39ee5.js"><link rel="prefetch" href="/assets/css/113.styles.407e8d7f.css"><link rel="prefetch" href="/assets/js/113.407e8d7f.js">
    <link rel="stylesheet" href="/assets/css/112.styles.75c39ee5.css"><link rel="stylesheet" href="/assets/css/113.styles.407e8d7f.css"><link rel="stylesheet" href="/assets/css/styles.7863e8ac.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">油腻中年大叔</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/dart/" class="nav-link">Dart</a></div><div class="nav-item"><a href="/spring/" class="nav-link router-link-active">spring</a></div><div class="nav-item"><a href="/drools/" class="nav-link">规则和业务流程</a></div><div class="nav-item"><a href="/eip/" class="nav-link">EIP集成工具</a></div><div class="nav-item"><a href="/other/" class="nav-link">杂项</a></div><div class="nav-item"><a href="/algorithms/" class="nav-link">算法</a></div><div class="nav-item"><a href="/riding/" class="nav-link">骑行</a></div><div class="nav-item"><a href="/ev3/" class="nav-link">LEGO EV3 </a></div><div class="nav-item"><a href="/rubik/" class="nav-link">魔方</a></div><div class="nav-item"><a href="/mb/" class="nav-link">Micro:bit </a></div><div class="nav-item"><a href="/math/" class="nav-link">小学数学 </a></div><div class="nav-item"><a href="/eng/" class="nav-link">小学英语 </a></div><div class="nav-item"><a href="/jp/" class="nav-link">日语 </a></div><div class="nav-item"><a href="/gs1/" class="nav-link">GS-1</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/dart/" class="nav-link">Dart</a></div><div class="nav-item"><a href="/spring/" class="nav-link router-link-active">spring</a></div><div class="nav-item"><a href="/drools/" class="nav-link">规则和业务流程</a></div><div class="nav-item"><a href="/eip/" class="nav-link">EIP集成工具</a></div><div class="nav-item"><a href="/other/" class="nav-link">杂项</a></div><div class="nav-item"><a href="/algorithms/" class="nav-link">算法</a></div><div class="nav-item"><a href="/riding/" class="nav-link">骑行</a></div><div class="nav-item"><a href="/ev3/" class="nav-link">LEGO EV3 </a></div><div class="nav-item"><a href="/rubik/" class="nav-link">魔方</a></div><div class="nav-item"><a href="/mb/" class="nav-link">Micro:bit </a></div><div class="nav-item"><a href="/math/" class="nav-link">小学数学 </a></div><div class="nav-item"><a href="/eng/" class="nav-link">小学英语 </a></div><div class="nav-item"><a href="/jp/" class="nav-link">日语 </a></div><div class="nav-item"><a href="/gs1/" class="nav-link">GS-1</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/spring/writetofile.html" class="sidebar-link">JavaIO-DataoutPut</a></li><li><a href="/spring/java-classloader.html" class="sidebar-link">java类加载器</a></li><li><a href="/spring/jvm-stack.html" class="sidebar-link">jvm 相关</a></li><li><a href="/spring/annotation.html" class="sidebar-link">注解的使用</a></li><li><a href="/spring/SpringAnnotations.html" class="sidebar-link">Spring注解速查</a></li><li><a href="/spring/springboot.html" class="sidebar-link">Springboot 配置速查</a></li><li><a href="/spring/springbootRun.html" class="sidebar-link">Springboot启动过程</a></li><li><a href="/spring/springboot-gitlab-ci.html" class="sidebar-link">Springboot基于Gitlab持续集成</a></li><li><a href="/spring/SpringBootTesting.html" class="sidebar-link">SpringBoot 测试</a></li><li><a href="/spring/SpringbootTesting2.html" class="sidebar-link">SpringBoot 测试建议</a></li><li><a href="/spring/TestingControllersInSpringboot.html" class="sidebar-link">SpringBoot的Contoller测试</a></li><li><a href="/spring/JacksonObjectMapperCheetSheet.html" class="sidebar-link">Jackson ObjectMapper CheetSheet</a></li><li><a href="/spring/lock.html" class="active sidebar-link">占用bug分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/spring/lock.html#一起深度bug分析" class="sidebar-link">一起深度bug分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/spring/lock.html#业务背景" class="sidebar-link">业务背景</a></li><li class="sidebar-sub-header"><a href="/spring/lock.html#bug现象" class="sidebar-link">bug现象</a></li><li class="sidebar-sub-header"><a href="/spring/lock.html#分析过程" class="sidebar-link">分析过程</a></li><li class="sidebar-sub-header"><a href="/spring/lock.html#验证binlog" class="sidebar-link">验证binlog</a></li><li class="sidebar-sub-header"><a href="/spring/lock.html#实验2" class="sidebar-link">实验2</a></li><li class="sidebar-sub-header"><a href="/spring/lock.html#实验3" class="sidebar-link">实验3</a></li></ul></li></ul></li><li><a href="/spring/singleton-scope.html" class="sidebar-link">Spring MVC 并发与线程安全</a></li><li><a href="/spring/singleton.html" class="sidebar-link">设计模式-单件</a></li></ul> </div> <div class="page"> <div class="content"><h2 id="一起深度bug分析"><a href="#一起深度bug分析" aria-hidden="true" class="header-anchor">#</a> 一起深度bug分析</h2> <h3 id="业务背景"><a href="#业务背景" aria-hidden="true" class="header-anchor">#</a> 业务背景</h3> <pre><code>我们有一个业务是快速订单。快速订单提交审批后，会自动的生成发货单，然后自动占用库存，占用库存的时候订单微服务会调用库存微服务。
这是一个较长的事务。业务上我们分成了2段本地事务。生成发货单是订单服务的本地事务，占用库存是库存服务的本地事务。发货单通过feign调用库存服务成功后，本地提交事务，写发货单占用记录。（这里面涉及到2阶段事务以及事务补偿，我们暂时放在一边）。
</code></pre> <h3 id="bug现象"><a href="#bug现象" aria-hidden="true" class="header-anchor">#</a> bug现象</h3> <pre><code>对于某批次商品，发现分别发货单占用记录的占用总数与库存账分配的占用数不一致。发货单占用总数大于库存账占用。
</code></pre> <h3 id="分析过程"><a href="#分析过程" aria-hidden="true" class="header-anchor">#</a> 分析过程</h3> <ul><li><p>1 首先我们怀疑事务出了问题，如果订单事务没有回滚，那么是可能出现占用多的情况。
但是review代码以及检查日志，占用不成功的事务都成功的进行了回滚。</p></li> <li><p>2 订单服务和库存服务的数据库事务都要写binlog,我们又从binlog入手分析。统计后发现，在该时间段内的单据，出现问题批次的商品，库存占用业务对数据库更新了99次，如果一致的话，那么发货单占用记录应该也是99条，但是发货单占用记录却为100条。又仔细看了库存占用binlog日志，库存服务的占用记录正常，没有突然不一致的情况，所以数据库执行上看起来没有问题。</p></li> <li><p>3 问题已经大致定位到就是写入不一致导致的。继续review代码发现，订单业务先去查询库存，计算配货占用，写入占用记录表，然后feign调用库存业务申请占用，如果库存占用成功，则提交事务。那么为什么会出现写入不一致的情况呢？</p></li> <li><p>4 继续分析binlog日志，发现某一个订单有10条占用明细，但是库存服务只有9条update的binlog，然而订单占用记录却有10条。又回头看代码，发现代码逻辑漏洞一个，因为是批量申请占用的，例如发给库存服务10个商品以及占用数量，库存服务对10个商品进行占用，执行update语句，如果10条update，有9条update，另外一条没有匹配到或者没有更新，只要不是占用不成功（申请占用数量大于可占用数量），库存服务不给出异常，那么订单服务也认为成功了。</p></li></ul> <h3 id="验证binlog"><a href="#验证binlog" aria-hidden="true" class="header-anchor">#</a> 验证binlog</h3> <p><code>The binary log contains “events” that describe database changes such as table creation operations or changes to table data. It also contains events for statements that potentially could have made changes (for example, a DELETE which matched no rows), unless row-based logging is used. The binary log also contains information about how long each statement took that updated data.</code></p> <h4 id="实验1"><a href="#实验1" aria-hidden="true" class="header-anchor">#</a> 实验1</h4> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">update</span> film <span class="token keyword">set</span> title<span class="token operator">=</span><span class="token string">'ACADEMY DINOSAUR'</span> <span class="token keyword">where</span> film_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这条语句没有对数据库产生更改，因此也没有生成binlog</p> <h3 id="实验2"><a href="#实验2" aria-hidden="true" class="header-anchor">#</a> 实验2</h3> <p>在这个实验中，我们批量更新3条记录。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">begin</span><span class="token punctuation">;</span>
<span class="token keyword">UPDATE</span> film 
<span class="token keyword">SET</span> title <span class="token operator">=</span>
<span class="token keyword">CASE</span>
 <span class="token keyword">WHEN</span> film_id <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">THEN</span>
 <span class="token string">'ACADEMY DINOSAUR_2'</span> 
 <span class="token keyword">WHEN</span> film_id <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">THEN</span>
 <span class="token string">'ACE GOLDFINGER_2'</span> 
 <span class="token keyword">WHEN</span> film_id <span class="token operator">=</span> <span class="token number">3</span> <span class="token keyword">THEN</span>
 <span class="token string">'ACE GOLDFINGER_2'</span> 
<span class="token keyword">END</span>
<span class="token keyword">where</span> film_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>这条语句binlog日志为</p> <div class="language-sh line-numbers-mode"><pre class="language-text"><code>BEGIN
/*!*/;
# at 122620053
#201230  2:33:42 server id 1  end_log_pos 122620136 CRC32 0x0f2ed94d    Table_map: `freshalwms_test`.`film` mapped to number 316
# at 122620136
#201230  2:33:42 server id 1  end_log_pos 122620998 CRC32 0x5fa28f9c    Update_rows: table id 316 flags: STMT_END_F

'/*!*/;
### UPDATE `freshalwms_test`.`film`
### WHERE
###   @1=1 /* SHORTINT meta=0 nullable=0 is_null=0 */
###   @2='ACADEMY DINOSAUR' /* VARSTRING(765) meta=765 nullable=0 is_null=0 */
###   @3='A Epic Drama of a Feminist And a Mad Scientist who must Battle a Teacher in The Canadian Rockies' /* BLOB/TEXT meta=2 nullable=1 is_null=0 */
###   @4=2006 /* YEAR meta=0 nullable=1 is_null=0 */
###   @5=1 /* TINYINT meta=0 nullable=0 is_null=0 */
###   @6=NULL /* TINYINT meta=0 nullable=1 is_null=1 */
###   @7=6 /* TINYINT meta=0 nullable=0 is_null=0 */
###   @8=0.99 /* DECIMAL(4,2) meta=1026 nullable=0 is_null=0 */
###   @9=86 /* SHORTINT meta=0 nullable=1 is_null=0 */
###   @10=20.99 /* DECIMAL(5,2) meta=1282 nullable=0 is_null=0 */
###   @11=2 /* ENUM(1 byte) meta=63233 nullable=1 is_null=0 */
###   @12=b'00001100' /* SET(1 bytes) meta=63489 nullable=1 is_null=0 */
###   @13=1609266788 /* TIMESTAMP(0) meta=0 nullable=0 is_null=0 */
### SET
###   @1=1 /* SHORTINT meta=0 nullable=0 is_null=0 */
###   @2='ACADEMY DINOSAUR_2' /* VARSTRING(765) meta=765 nullable=0 is_null=0 */
###   @3='A Epic Drama of a Feminist And a Mad Scientist who must Battle a Teacher in The Canadian Rockies' /* BLOB/TEXT meta=2 nullable=1 is_null=0 */
###   @4=2006 /* YEAR meta=0 nullable=1 is_null=0 */
###   @5=1 /* TINYINT meta=0 nullable=0 is_null=0 */
###   @6=NULL /* TINYINT meta=0 nullable=1 is_null=1 */
###   @7=6 /* TINYINT meta=0 nullable=0 is_null=0 */
###   @8=0.99 /* DECIMAL(4,2) meta=1026 nullable=0 is_null=0 */
###   @9=86 /* SHORTINT meta=0 nullable=1 is_null=0 */
###   @10=20.99 /* DECIMAL(5,2) meta=1282 nullable=0 is_null=0 */
###   @11=2 /* ENUM(1 byte) meta=63233 nullable=1 is_null=0 */
###   @12=b'00001100' /* SET(1 bytes) meta=63489 nullable=1 is_null=0 */
###   @13=1609266822 /* TIMESTAMP(0) meta=0 nullable=0 is_null=0 */
### UPDATE `freshalwms_test`.`film`
### WHERE
###   @1=2 /* SHORTINT meta=0 nullable=0 is_null=0 */
###   @2='ACE GOLDFINGER' /* VARSTRING(765) meta=765 nullable=0 is_null=0 */
###   @3='A Astounding Epistle of a Database Administrator And a Explorer who must Find a Car in Ancient China' /* BLOB/TEXT meta=2 nullable=1 is_null=0 */
###   @4=2006 /* YEAR meta=0 nullable=1 is_null=0 */
###   @5=1 /* TINYINT meta=0 nullable=0 is_null=0 */
###   @6=NULL /* TINYINT meta=0 nullable=1 is_null=1 */
###   @7=3 /* TINYINT meta=0 nullable=0 is_null=0 */
###   @8=4.99 /* DECIMAL(4,2) meta=1026 nullable=0 is_null=0 */
###   @9=48 /* SHORTINT meta=0 nullable=1 is_null=0 */
###   @10=12.99 /* DECIMAL(5,2) meta=1282 nullable=0 is_null=0 */
###   @11=1 /* ENUM(1 byte) meta=63233 nullable=1 is_null=0 */
###   @12=b'00000101' /* SET(1 bytes) meta=63489 nullable=1 is_null=0 */
###   @13=1139951022 /* TIMESTAMP(0) meta=0 nullable=0 is_null=0 */
### SET
###   @1=2 /* SHORTINT meta=0 nullable=0 is_null=0 */
###   @2='ACE GOLDFINGER_2' /* VARSTRING(765) meta=765 nullable=0 is_null=0 */
###   @3='A Astounding Epistle of a Database Administrator And a Explorer who must Find a Car in Ancient China' /* BLOB/TEXT meta=2 nullable=1 is_null=0 */
###   @4=2006 /* YEAR meta=0 nullable=1 is_null=0 */
###   @5=1 /* TINYINT meta=0 nullable=0 is_null=0 */
###   @6=NULL /* TINYINT meta=0 nullable=1 is_null=1 */
###   @7=3 /* TINYINT meta=0 nullable=0 is_null=0 */
###   @8=4.99 /* DECIMAL(4,2) meta=1026 nullable=0 is_null=0 */
###   @9=48 /* SHORTINT meta=0 nullable=1 is_null=0 */
###   @10=12.99 /* DECIMAL(5,2) meta=1282 nullable=0 is_null=0 */
###   @11=1 /* ENUM(1 byte) meta=63233 nullable=1 is_null=0 */
###   @12=b'00000101' /* SET(1 bytes) meta=63489 nullable=1 is_null=0 */
###   @13=1609266822 /* TIMESTAMP(0) meta=0 nullable=0 is_null=0 */
### UPDATE `freshalwms_test`.`film`
### WHERE
###   @1=3 /* SHORTINT meta=0 nullable=0 is_null=0 */
###   @2='ADAPTATION HOLES' /* VARSTRING(765) meta=765 nullable=0 is_null=0 */
###   @3='A Astounding Reflection of a Lumberjack And a Car who must Sink a Lumberjack in A Baloon Factory' /* BLOB/TEXT meta=2 nullable=1 is_null=0 */
###   @4=2006 /* YEAR meta=0 nullable=1 is_null=0 */
###   @5=1 /* TINYINT meta=0 nullable=0 is_null=0 */
###   @6=NULL /* TINYINT meta=0 nullable=1 is_null=1 */
###   @7=7 /* TINYINT meta=0 nullable=0 is_null=0 */
###   @8=2.99 /* DECIMAL(4,2) meta=1026 nullable=0 is_null=0 */
###   @9=50 /* SHORTINT meta=0 nullable=1 is_null=0 */
###   @10=18.99 /* DECIMAL(5,2) meta=1282 nullable=0 is_null=0 */
###   @11=5 /* ENUM(1 byte) meta=63233 nullable=1 is_null=0 */
###   @12=b'00000101' /* SET(1 bytes) meta=63489 nullable=1 is_null=0 */
###   @13=1139951022 /* TIMESTAMP(0) meta=0 nullable=0 is_null=0 */
### SET
###   @1=3 /* SHORTINT meta=0 nullable=0 is_null=0 */
###   @2='ACE GOLDFINGER_2' /* VARSTRING(765) meta=765 nullable=0 is_null=0 */
###   @3='A Astounding Reflection of a Lumberjack And a Car who must Sink a Lumberjack in A Baloon Factory' /* BLOB/TEXT meta=2 nullable=1 is_null=0 */
###   @4=2006 /* YEAR meta=0 nullable=1 is_null=0 */
###   @5=1 /* TINYINT meta=0 nullable=0 is_null=0 */
###   @6=NULL /* TINYINT meta=0 nullable=1 is_null=1 */
###   @7=7 /* TINYINT meta=0 nullable=0 is_null=0 */
###   @8=2.99 /* DECIMAL(4,2) meta=1026 nullable=0 is_null=0 */
###   @9=50 /* SHORTINT meta=0 nullable=1 is_null=0 */
###   @10=18.99 /* DECIMAL(5,2) meta=1282 nullable=0 is_null=0 */
###   @11=5 /* ENUM(1 byte) meta=63233 nullable=1 is_null=0 */
###   @12=b'00000101' /* SET(1 bytes) meta=63489 nullable=1 is_null=0 */
###   @13=1609266822 /* TIMESTAMP(0) meta=0 nullable=0 is_null=0 */
# at 122620998
#201230  2:33:42 server id 1  end_log_pos 122621029 CRC32 0xa38697a9    Xid = 2069954
COMMIT/*!*/;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br></div></div><h3 id="实验3"><a href="#实验3" aria-hidden="true" class="header-anchor">#</a> 实验3</h3> <p>在这个实验中，我们批量更新3条记录，其中有2条可以更新，另外一条更新不到</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">begin</span><span class="token punctuation">;</span>
<span class="token keyword">UPDATE</span> film 
<span class="token keyword">SET</span> title <span class="token operator">=</span>
<span class="token keyword">CASE</span>
 <span class="token keyword">WHEN</span> film_id <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">THEN</span>
 <span class="token string">'ACADEMY DINOSAUR_2'</span> 
 <span class="token keyword">WHEN</span> film_id <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">THEN</span>
 <span class="token string">'ACE GOLDFINGER_2'</span> 
 <span class="token keyword">WHEN</span> film_id <span class="token operator">=</span> <span class="token number">3</span> <span class="token keyword">THEN</span>
 <span class="token string">'ACE GOLDFINGER_2'</span> 
<span class="token keyword">END</span>
<span class="token keyword">where</span> film_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><img src="/assets/img/update3.f164d6de.jpg" alt="binlog"></p> <p>这条语句binlog日志为</p> <div class="language-sh line-numbers-mode"><pre class="language-text"><code>BEGIN
/*!*/;
# at 140854194
#201230 14:01:17 server id 1  end_log_pos 140854277 CRC32 0x38ebc8a3 	Table_map: `freshalwms_test`.`film` mapped to number 316
# at 140854277
#201230 14:01:17 server id 1  end_log_pos 140854867 CRC32 0x94e3bc40 	Update_rows: table id 316 flags: STMT_END_F
### UPDATE `freshalwms_test`.`film`
### WHERE
###   @1=1 /* SHORTINT meta=0 nullable=0 is_null=0 */
###   @2='ACADEMY DINOSAUR_2' /* VARSTRING(765) meta=765 nullable=0 is_null=0 */
###   @3='A Epic Drama of a Feminist And a Mad Scientist who must Battle a Teacher in The Canadian Rockies' /* BLOB/TEXT meta=2 nullable=1 is_null=0 */
###   @4=2006 /* YEAR meta=0 nullable=1 is_null=0 */
###   @5=1 /* TINYINT meta=0 nullable=0 is_null=0 */
###   @6=NULL /* TINYINT meta=0 nullable=1 is_null=1 */
###   @7=6 /* TINYINT meta=0 nullable=0 is_null=0 */
###   @8=0.99 /* DECIMAL(4,2) meta=1026 nullable=0 is_null=0 */
###   @9=86 /* SHORTINT meta=0 nullable=1 is_null=0 */
###   @10=20.99 /* DECIMAL(5,2) meta=1282 nullable=0 is_null=0 */
###   @11=2 /* ENUM(1 byte) meta=63233 nullable=1 is_null=0 */
###   @12=b'00001100' /* SET(1 bytes) meta=63489 nullable=1 is_null=0 */
###   @13=1609266822 /* TIMESTAMP(0) meta=0 nullable=0 is_null=0 */
### SET
###   @1=1 /* SHORTINT meta=0 nullable=0 is_null=0 */
###   @2='ACADEMY DINOSAUR' /* VARSTRING(765) meta=765 nullable=0 is_null=0 */
###   @3='A Epic Drama of a Feminist And a Mad Scientist who must Battle a Teacher in The Canadian Rockies' /* BLOB/TEXT meta=2 nullable=1 is_null=0 */
###   @4=2006 /* YEAR meta=0 nullable=1 is_null=0 */
###   @5=1 /* TINYINT meta=0 nullable=0 is_null=0 */
###   @6=NULL /* TINYINT meta=0 nullable=1 is_null=1 */
###   @7=6 /* TINYINT meta=0 nullable=0 is_null=0 */
###   @8=0.99 /* DECIMAL(4,2) meta=1026 nullable=0 is_null=0 */
###   @9=86 /* SHORTINT meta=0 nullable=1 is_null=0 */
###   @10=20.99 /* DECIMAL(5,2) meta=1282 nullable=0 is_null=0 */
###   @11=2 /* ENUM(1 byte) meta=63233 nullable=1 is_null=0 */
###   @12=b'00001100' /* SET(1 bytes) meta=63489 nullable=1 is_null=0 */
###   @13=1609308077 /* TIMESTAMP(0) meta=0 nullable=0 is_null=0 */
### UPDATE `freshalwms_test`.`film`
### WHERE
###   @1=2 /* SHORTINT meta=0 nullable=0 is_null=0 */
###   @2='ACE GOLDFINGER_2' /* VARSTRING(765) meta=765 nullable=0 is_null=0 */
###   @3='A Astounding Epistle of a Database Administrator And a Explorer who must Find a Car in Ancient China' /* BLOB/TEXT meta=2 nullable=1 is_null=0 */
###   @4=2006 /* YEAR meta=0 nullable=1 is_null=0 */
###   @5=1 /* TINYINT meta=0 nullable=0 is_null=0 */
###   @6=NULL /* TINYINT meta=0 nullable=1 is_null=1 */
###   @7=3 /* TINYINT meta=0 nullable=0 is_null=0 */
###   @8=4.99 /* DECIMAL(4,2) meta=1026 nullable=0 is_null=0 */
###   @9=48 /* SHORTINT meta=0 nullable=1 is_null=0 */
###   @10=12.99 /* DECIMAL(5,2) meta=1282 nullable=0 is_null=0 */
###   @11=1 /* ENUM(1 byte) meta=63233 nullable=1 is_null=0 */
###   @12=b'00000101' /* SET(1 bytes) meta=63489 nullable=1 is_null=0 */
###   @13=1609266822 /* TIMESTAMP(0) meta=0 nullable=0 is_null=0 */
### SET
###   @1=2 /* SHORTINT meta=0 nullable=0 is_null=0 */
###   @2='ACE GOLDFINGER' /* VARSTRING(765) meta=765 nullable=0 is_null=0 */
###   @3='A Astounding Epistle of a Database Administrator And a Explorer who must Find a Car in Ancient China' /* BLOB/TEXT meta=2 nullable=1 is_null=0 */
###   @4=2006 /* YEAR meta=0 nullable=1 is_null=0 */
###   @5=1 /* TINYINT meta=0 nullable=0 is_null=0 */
###   @6=NULL /* TINYINT meta=0 nullable=1 is_null=1 */
###   @7=3 /* TINYINT meta=0 nullable=0 is_null=0 */
###   @8=4.99 /* DECIMAL(4,2) meta=1026 nullable=0 is_null=0 */
###   @9=48 /* SHORTINT meta=0 nullable=1 is_null=0 */
###   @10=12.99 /* DECIMAL(5,2) meta=1282 nullable=0 is_null=0 */
###   @11=1 /* ENUM(1 byte) meta=63233 nullable=1 is_null=0 */
###   @12=b'00000101' /* SET(1 bytes) meta=63489 nullable=1 is_null=0 */
###   @13=1609308077 /* TIMESTAMP(0) meta=0 nullable=0 is_null=0 */
# at 140854867
#201230 14:01:17 server id 1  end_log_pos 140854898 CRC32 0xde887e33 	Xid = 2377876
COMMIT/*!*/;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div><p>可以看到只有两个update语句，而第三个没有update。</p> <p>这证实了我们的怀疑。</p> <p>继续review代码。iwm有2个服务实例，用了redis key作为lock锁。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> Exception<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">addSummaryAllocQty</span><span class="token punctuation">(</span>InvSummaryAllocQtyDTO summaryAllocQtyDTO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//库存锁</span>
        String redisLockKey <span class="token operator">=</span> RedisLockKey<span class="token punctuation">.</span>IWM_LOCK<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>RedisLockKey<span class="token punctuation">.</span>APP_INFO_PLACEHOLDER0<span class="token punctuation">,</span> summaryAllocQtyDTO<span class="token punctuation">.</span><span class="token function">getWarehouseID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span>summaryAllocQtyDTO<span class="token punctuation">.</span><span class="token function">getCustomerID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>redisLockService<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span>redisLockKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ImInvSummary imInvSummary <span class="token operator">=</span> imInvSummaryMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>summaryAllocQtyDTO<span class="token punctuation">.</span><span class="token function">getInvSummaryID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>imInvSummary <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;占用数量调整异常, 库存明细-[{}] 查询为空&quot;</span><span class="token punctuation">,</span> summaryAllocQtyDTO<span class="token punctuation">.</span><span class="token function">getInvSummaryID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SystemException</span><span class="token punctuation">(</span>BaseErrorCodes<span class="token punctuation">.</span>NOTNULL<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">&quot;库存明细-[&quot;</span> <span class="token operator">+</span> summaryAllocQtyDTO<span class="token punctuation">.</span><span class="token function">getInvSummaryID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//判断调整单调整前数量是否与库存数量一致 todo</span>
<span class="token comment">//                if (summaryAllocQtyDTO.getDocType().equals(DocType.ADJUST.getValue())) {</span>
<span class="token comment">//                    if (imInvSummary.getBalanceQty().compareTo(summaryAllocQtyDTO.getBeforeQty()) != 0) {</span>
<span class="token comment">//                        logger.error(&quot;调整单过账异常, SKU-[{}] 过账前数量[{}] 与 库存余额[{}] 不一致&quot;, imInvSummary.getSkuID(), summaryAllocQtyDTO.getBeforeQty(), imInvSummary.getBalanceQty());</span>
<span class="token comment">//                        throw new SystemException(OrderErrorCodes.QTY_ERROR, new Object[]{&quot;sku-&quot; + imInvSummary.getSkuID() + &quot;-调整前&quot;});</span>
<span class="token comment">//                    }</span>
<span class="token comment">//                }</span>
                <span class="token comment">//调整后数量</span>
                BigDecimal afterAllocQty <span class="token operator">=</span> imInvSummary<span class="token punctuation">.</span><span class="token function">getAllocQty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>summaryAllocQtyDTO<span class="token punctuation">.</span><span class="token function">getQty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>afterAllocQty<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>imInvSummary<span class="token punctuation">.</span><span class="token function">getBalanceQty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Sku sku <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">searchSKUByID</span><span class="token punctuation">(</span>imInvSummary<span class="token punctuation">.</span><span class="token function">getSkuID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    String skuName <span class="token operator">=</span> StringUtils<span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getCommonName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> sku<span class="token punctuation">.</span><span class="token function">getCommonName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> sku<span class="token punctuation">.</span><span class="token function">getSkuStdName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;占用数量调整异常, SKU-[{}]-[{}] 库存明细 -[{}] 调整后占用数量[{}] 大于库存余额数量[{}]&quot;</span><span class="token punctuation">,</span> imInvSummary<span class="token punctuation">.</span><span class="token function">getSkuID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> skuName<span class="token punctuation">,</span> imInvSummary<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> afterAllocQty<span class="token punctuation">,</span> imInvSummary<span class="token punctuation">.</span><span class="token function">getBalanceQty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SystemException</span><span class="token punctuation">(</span>OrderErrorCodes<span class="token punctuation">.</span>QTY_ERROR<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">&quot;占用数量调整异常, SKU-&quot;</span> <span class="token operator">+</span> sku<span class="token punctuation">.</span><span class="token function">getSkuCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> skuName <span class="token operator">+</span> <span class="token string">&quot;批次：&quot;</span> <span class="token operator">+</span> imInvSummary<span class="token punctuation">.</span><span class="token function">getLotNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;,调整后占用数量:&quot;</span> <span class="token operator">+</span> afterAllocQty <span class="token operator">+</span> <span class="token string">&quot; ,大于库存余额数量:&quot;</span> <span class="token operator">+</span> imInvSummary<span class="token punctuation">.</span><span class="token function">getBalanceQty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                imInvSummary<span class="token punctuation">.</span><span class="token function">setAllocQty</span><span class="token punctuation">(</span>afterAllocQty<span class="token punctuation">)</span><span class="token punctuation">;</span>
                imInvSummary<span class="token punctuation">.</span><span class="token function">preUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> imInvSummaryMapper<span class="token punctuation">.</span><span class="token function">updateByPrimaryKeySelective</span><span class="token punctuation">(</span>imInvSummary<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;占用数量调整异常：&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                redisLockService<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span>redisLockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;占用数量调整异常, 未获取到redislock : {} 或调整明细-{}处于锁定状态&quot;</span><span class="token punctuation">,</span> redisLockKey<span class="token punctuation">,</span> summaryAllocQtyDTO<span class="token punctuation">.</span><span class="token function">getInvSummaryID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//            throw new RuntimeException(&quot;未获取到redislock : &quot; + redisLockKey);</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SystemException</span><span class="token punctuation">(</span>OrderErrorCodes<span class="token punctuation">.</span>OPERATION_FAILED<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">&quot;需要调整明细处于锁定状态,稍后重试&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
    * 批量增加占用
    *
    * @author tongt.gao
    * @param
    * @createDate 2020/12/22 14:59
    **/</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> Exception<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addBatchSummaryAllocQty</span><span class="token punctuation">(</span>List<span class="token generics function"><span class="token punctuation">&lt;</span>InvSummaryAllocQtyDTO<span class="token punctuation">&gt;</span></span> dtoList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//根据仓库及货主信息分组</span>
        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>InvSummaryAllocQtyDTO<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> customerMap <span class="token operator">=</span> dtoList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">groupingBy</span><span class="token punctuation">(</span>a <span class="token operator">-</span><span class="token operator">&gt;</span> a<span class="token punctuation">.</span><span class="token function">getWarehouseID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> a<span class="token punctuation">.</span><span class="token function">getCustomerID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//循环处理每个货主的占用</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>InvSummaryAllocQtyDTO<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> detail <span class="token operator">:</span> customerMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> begin <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//redis锁key值</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;批量增加占用开始获取 RedisLockKey：warehouseID:customerID:{}&quot;</span><span class="token punctuation">,</span> detail<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            String redisLockKey <span class="token operator">=</span> RedisLockKey<span class="token punctuation">.</span>IWM_LOCK<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>RedisLockKey<span class="token punctuation">.</span>APP_INFO_PLACEHOLDER0<span class="token punctuation">,</span> detail<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>redisLockService<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span>redisLockKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;批量增加占用RedisLockKey获取成功，RedisLockKey: {}，耗时：{} ms&quot;</span><span class="token punctuation">,</span> redisLockKey<span class="token punctuation">,</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    List<span class="token generics function"><span class="token punctuation">&lt;</span>ImInvSummary<span class="token punctuation">&gt;</span></span> summaryList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>InvSummaryAllocQtyDTO invSummaryAllocQtyDTO <span class="token operator">:</span> detail<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        summaryList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkSummary</span><span class="token punctuation">(</span>invSummaryAllocQtyDTO<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//批量更新库存明细</span>
                    imInvSummaryMapper<span class="token punctuation">.</span><span class="token function">updateQtyBatch</span><span class="token punctuation">(</span>summaryList<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;占用数量调整异常：&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    redisLockService<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span>redisLockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;批量增加占用结束，RedisLockKey释放成功，RedisLockKey: {}，耗时：{}&quot;</span><span class="token punctuation">,</span> redisLockKey<span class="token punctuation">,</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;占用数量调整异常, redislock : {} 未获取到或处于锁定状态&quot;</span><span class="token punctuation">,</span> redisLockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SystemException</span><span class="token punctuation">(</span>OrderErrorCodes<span class="token punctuation">.</span>OPERATION_FAILED<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">&quot;需要调整明细处于锁定状态,稍后重试&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br></div></div><p>由于数据库事务隔离级别为READ COMMITED,在并发高的情况下，会有概率出现</p> <table><thead><tr><th>步骤</th> <th>iwm1</th> <th>iwm2</th></tr></thead> <tbody><tr><td>1</td> <td>开始数据库事务</td> <td></td></tr> <tr><td>2</td> <td></td> <td>开始数据库事务</td></tr> <tr><td>3</td> <td>准备获得redis lock</td> <td></td></tr> <tr><td>4</td> <td></td> <td>准备获得redis lock</td></tr> <tr><td>5</td> <td>获得redis lock成功</td> <td></td></tr> <tr><td>6</td> <td></td> <td>等待redis lock</td></tr> <tr><td>7</td> <td>执行数据库事务</td> <td>等待redis lock</td></tr> <tr><td>8</td> <td>释放锁</td> <td>等待redis lock</td></tr> <tr><td>9</td> <td>释放成功</td> <td>等待redis lock</td></tr> <tr><td>10</td> <td></td> <td>获得redis lock锁成功</td></tr> <tr><td>11</td> <td></td> <td>查询summary占用余额</td></tr> <tr><td>12</td> <td>提交数据库事务</td> <td></td></tr></tbody></table> <p>上表，如果iwm1在还没有提交数据库事务的情况下，iwm2获得的占用余额就是未更新的，这样就出现了脏读，导致iwm可能也去更新同样数量的占用</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> alloc <span class="token keyword">from</span> summary <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment">// alloc = 100</span>
<span class="token comment">// 100-1 =99</span>
<span class="token keyword">update</span> summary <span class="token keyword">set</span> alloc<span class="token operator">=</span><span class="token number">99</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>对于iwm2可能也是要去占用1个</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> alloc <span class="token keyword">from</span> summary <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment">// alloc = 100</span>
<span class="token comment">// 100-1 =99</span>
<span class="token keyword">update</span> summary <span class="token keyword">set</span> alloc<span class="token operator">=</span><span class="token number">99</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这个时候iwm2，因为alloc已经是99个了，就不会执行update</p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/spring/JacksonObjectMapperCheetSheet.html" class="prev">
          Jackson ObjectMapper CheetSheet
        </a></span> <span class="next"><a href="/spring/singleton-scope.html">
          Spring MVC 并发与线程安全
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/8.5752a787.js" defer></script><script src="/assets/js/app.7863e8ac.js" defer></script>
  </body>
</html>
